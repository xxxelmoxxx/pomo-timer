<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ポモドーロタイマー</title>
<link rel="icon" href="favicon.png" type="image/png">
<link rel="apple-touch-icon" href="favicon.png">
<style>
  :root{
    /* テーマ変数（JSから切替） */
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text:#ffffff;
    --muted: rgba(255,255,255,.88);

    --accent:#38bdf8;      /* 主要アクセント */
    --accent2:#a78bfa;     /* 補助アクセント（任意） */
    --break:#22c55e;       /* 休憩 */

    --start1:#22c55e;
    --start2:#16a34a;
    --stop1:#6b7280;
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);
    --radius: 18px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 18px;
  }

  .wrap{
    width: min(980px, 100%);
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap: 16px;
  }
  @media (max-width: 860px){
    .wrap{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--card);
    border: 1px solid rgba(255,255,255,.18);
    border-radius: var(--radius);
    box-shadow: 0 14px 40px var(--shadow);
    padding: 18px;
    backdrop-filter: blur(8px);
  }

  .header{
    display:flex;
    justify-content:space-between;
    gap: 12px;
    align-items:flex-start;
    margin-bottom: 10px;
  }

  h1{ margin:0; font-size: 18px; letter-spacing:.02em; }
  .sub{ margin-top:6px; color: var(--muted); font-size: 13px; line-height: 1.5; }

  .pill{
    background: rgba(255,255,255,.16);
    border: 1px solid rgba(255,255,255,.18);
    padding: 8px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* ★タブ（モード選択） */
  .tabs{
    display:flex;
    gap: 8px;
    padding: 8px;
    border-radius: 14px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.16);
    margin: 10px 0 10px;
  }
  .tabbtn{
    flex:1;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.10);
    color: rgba(255,255,255,.92);
    padding: 10px 10px;
    border-radius: 12px;
    font-weight: 650;
    cursor:pointer;
    font-size: 12px;
    letter-spacing:.02em;
  }
  .tabbtn.active{
    background: linear-gradient(135deg, rgba(56,189,248,.40), rgba(167,139,250,.35));
    border-color: rgba(255,255,255,.28);
  }

  /* タイマー表示 */
  .phaseRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top: 10px; }
  .phaseTag{
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 10px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: var(--muted);
    font-size: 12px;
  }

  .dot{
    width:10px; height:10px; border-radius:999px;
    background: var(--accent);
    box-shadow: 0 0 12px rgba(56,189,248,.7);
  }
  .dot.break{
    background: var(--break);
    box-shadow: 0 0 12px rgba(34,197,94,.65);
  }

  .bigTime{
    font-variant-numeric: tabular-nums;
    font-size: 64px;
    text-align:center;
    margin: 12px 0 10px;
    letter-spacing: .02em;
  }

  .progress{
    width:100%;
    height: 14px;
    background: rgba(255,255,255,.16);
    border-radius: 999px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.18);
  }
  .bar{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(14,165,233,.85));
    border-radius: 999px;
    transition: width .25s linear;
  }
  .bar.break{
    background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(22,163,74,.85));
  }

  .controls{
    display:flex; flex-wrap:wrap; gap: 10px;
    justify-content:center; margin-top: 12px;
  }

  button{
    border:0;
    padding: 12px 14px;
    border-radius: 12px;
    cursor:pointer;
    color: var(--text);
    font-weight: 650;
    letter-spacing:.02em;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.18);
  }
  .primary{
    background: linear-gradient(135deg, var(--start1), var(--start2));
  }
  .secondary{
    background: linear-gradient(135deg, var(--stop1), var(--stop2));
  }
  .warn{
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  /* 右側設定 */
  label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  select, input[type="number"]{
    width:100%;
    padding: 12px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.18);
    color: var(--text);
    outline:none;
  }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

  .switch{
    display:flex; align-items:center; gap: 10px;
    padding: 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.16);
  }
  .switch input{ transform: scale(1.2); }

  .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }

  .hint{ color: var(--muted); font-size: 12px; line-height: 1.6; margin-top: 10px; }

  /* 休憩中だけ波紋アニメーション */
  .rippleWrap{
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-top: 6px;
    height: 140px;
  }

  .ripple{
    position:absolute;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    opacity: 0;
    border: 2px solid rgba(34,197,94,.65);
    box-shadow: 0 0 18px rgba(34,197,94,.25);
  }

  .rippleOn .ripple{
    opacity: 1;
    animation: ripple 2.6s ease-out infinite;
  }
  .rippleOn .ripple.r2{ animation-delay: .8s; }
  .rippleOn .ripple.r3{ animation-delay: 1.6s; }

  @keyframes ripple{
    0%   { transform: scale(1);   opacity: .0; }
    15%  { opacity: .65; }
    100% { transform: scale(14); opacity: 0; }
  }

  .rippleText{
    z-index: 2;
    color: rgba(255,255,255,.92);
    font-size: 13px;
    text-align:center;
    line-height: 1.5;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.14);
  }

  /* 左下メッセージ：カード化 */
  .messageCard{
    margin-top: 14px;
    padding: 14px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.20);
    box-shadow: 0 10px 24px rgba(0,0,0,.12);
    font-size: 15px;
    line-height: 1.8;
    color: rgba(255,255,255,.95);
  }
  @media (max-width: 860px){
    .messageCard{ font-size: 16px; }
  }

  /* detailsをUIとして馴染ませる */
  details.panel{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.08);
    border-radius: 12px;
    padding: 10px 10px;
  }
  details.panel > summary{
    cursor: pointer;
    list-style: none;
    font-weight: 650;
    color: rgba(255,255,255,.92);
    outline: none;
  }
  details.panel > summary::-webkit-details-marker{ display:none; }
  details.panel .inner{ margin-top: 10px; }

  /* 右パネルをコンパクトに */
  .compact{ padding: 14px; }
  .compact .grid{ gap: 10px; }
  .compact label{ margin-bottom: 4px; }
  .compact select, .compact input[type="number"]{ padding: 10px 10px; border-radius: 10px; }
  .compact .switch{ padding: 10px; border-radius: 12px; }
  .compact .hint{ margin-top: 6px; line-height: 1.5; }
  .compact button{ padding: 10px 12px; border-radius: 10px; }

  /* エラー表示 */
  .error{
    margin-top: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: rgba(255,255,255,.92);
    font-size: 12px;
    line-height: 1.55;
    display:none;
    white-space: pre-wrap;
  }
  .error.show{ display:block; }

  /* ★A/B入力の表示切替 */
  .onlyAB{ display:none; }
  .modeAB .onlyAB{ display:block; }
  .modeAB .onlySingle{ display:none; }
</style>
</head>

<body>
  <div class="wrap">
    <!-- Left: Timer -->
    <section class="card compact" id="leftCard">
      <div class="header">
        <div>
          <h1>ポモドーロタイマー</h1>
        </div>
        <div class="pill" id="presetLabel">Preset: 25/5</div>
      </div>

      <!-- ★モードタブ（復活） -->
      <div class="tabs" role="tablist" aria-label="モード選択">
        <button class="tabbtn" id="tabSingle" type="button" role="tab" aria-selected="true">作業＋休憩</button>
        <button class="tabbtn" id="tabAB" type="button" role="tab" aria-selected="false">作業A＋作業B＋休憩</button>
      </div>

      <div class="phaseRow">
        <div class="phaseTag"><span class="dot" id="phaseDot"></span><span id="phaseText">作業</span></div>
        <div class="pill">セット: <span id="setCount">1</span> / <span id="setTotal">4</span></div>
      </div>

      <div class="bigTime" id="timeText">25:00</div>

      <div class="progress" aria-label="progress">
        <div class="bar" id="bar"></div>
      </div>

      <!-- 休憩中だけ波紋 -->
      <div class="rippleWrap" id="rippleWrap" aria-hidden="true">
        <div class="ripple r1"></div>
        <div class="ripple r2"></div>
        <div class="ripple r3"></div>
        <div class="rippleText" id="rippleText">休憩中：肩を落として、呼吸をひとつ。</div>
      </div>

      <div class="controls">
        <button class="primary" id="btnStart">開始</button>
        <button class="secondary" id="btnPause" disabled>一時停止</button>
        <button id="btnReset">リセット</button>
        <button class="warn" id="btnSkip">次へ</button>
      </div>

      <div class="messageCard" id="messageBox"></div>
    </section>

    <!-- Right: Settings + BGM (compact) -->
    <section class="card compact">
      <div class="header">
        <div>
          <h1>設定 / BGM</h1>
          <div class="sub">テーマは1回のプルダウン選択。プリセットは従来どおり。</div>
        </div>
      </div>

      <!-- ★テーマ選択（1段階） -->
      <div style="margin-bottom:12px;">
        <label for="themeSelect">テーマ</label>
        <select id="themeSelect"></select>
      </div>

      <div class="grid">
        <div>
          <label for="preset">プリセット</label>
          <select id="preset">
            <option value="25_5_4_15">標準 25/5（4セットごとに長休憩15）</option>
            <option value="50_10_2_20">深集中 50/10（2セットごとに長休憩20）</option>
            <option value="45_15_2_30">しっかり 45/15（2セットごとに長休憩30）</option>
            <option value="15_5_4_10">入門 15/5（4セットごとに長休憩10）</option>
            <option value="custom">カスタム</option>
          </select>
        </div>

        <div>
          <label for="sets">1サイクルのセット数</label>
          <input id="sets" type="number" min="1" max="12" value="4" />
        </div>

        <!-- ★作業（単一モード） -->
        <div class="onlySingle">
          <label for="workMin">作業（分）</label>
          <input id="workMin" type="number" min="1" max="180" value="25" />
        </div>

        <!-- ★作業A/B（ABモード） -->
        <div class="onlyAB">
          <label for="workAMin">作業A（分）</label>
          <input id="workAMin" type="number" min="1" max="180" value="25" />
        </div>
        <div class="onlyAB">
          <label for="workBMin">作業B（分）</label>
          <input id="workBMin" type="number" min="1" max="180" value="25" />
        </div>

        <div>
          <label for="breakMin">休憩（分）</label>
          <input id="breakMin" type="number" min="1" max="60" value="5" />
        </div>

        <div>
          <label for="longEvery">長休憩の頻度（何セットごと）</label>
          <input id="longEvery" type="number" min="0" max="12" value="4" />
        </div>

        <div>
          <label for="longMin">長休憩（分）</label>
          <input id="longMin" type="number" min="1" max="120" value="15" />
        </div>
      </div>

      <div style="margin-top:12px; display:grid; gap:10px;">
        <!-- 自動で次フェーズへ -->
        <div class="switch">
          <input id="autoNext" type="checkbox" checked />
          <div>
            <div style="font-weight:650;">自動で次フェーズへ</div>
            <div class="hint" style="margin:6px 0 0;">ONだと、0秒で作業↔休憩を自動切替</div>
          </div>
        </div>

        <!-- フェーズ切替サウンド -->
        <details class="panel" open>
          <summary>フェーズ切替サウンド</summary>
          <div class="inner">
            <div class="row" style="gap:12px; align-items:center;">
              <label style="margin:0; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="seEnabled" checked />
                <span>切替サウンドを鳴らす</span>
              </label>
              <button type="button" id="btnSeTest">音テスト</button>
            </div>

            <div style="margin-top:10px;">
              <label for="seSelect">音の種類</label>
              <select id="seSelect">
                <option value="beep">ピッ（短）</option>
                <option value="double">ピピ（2回）</option>
                <option value="ding">ポン（柔らか）</option>
                <option value="alarm">ピピピ（強め）</option>
              </select>
            </div>

            <div class="hint" style="margin-top:10px;">
              注意：ブラウザ仕様で、最初の音出しは「開始」などユーザー操作が必要です。
            </div>
          </div>
        </details>

        <!-- BGM -->
        <details class="panel" open>
          <summary>BGM</summary>
          <div class="inner">
            <div>
              <label for="bgmSelect">BGM（プルダウン）</label>
              <select id="bgmSelect">
                <option value="">なし</option>
                <option value="10degrees_Celsius_2.mp3">10degrees_Celsius_2.mp3</option>
                <option value="2_23_AM_2.mp3">2_23_AM_2.mp3</option>
                <option value="Chill_Sunset.mp3">Chill_Sunset.mp3</option>
                <option value="You_and_Me_2.mp3">You_and_Me_2.mp3</option>
                <option value="優しい灯火(Tenderly_glow).mp3">優しい灯火(Tenderly_glow).mp3</option>
                <option value="神隠しの真相_2.mp3">神隠しの真相_2.mp3</option>
                <option value="野良猫は宇宙を目指した_2.mp3">野良猫は宇宙を目指した_2.mp3</option>
              </select>
            </div>

            <div class="row" style="margin-top:10px;">
              <button type="button" id="btnBgmPlay">BGM 再生</button>
              <button type="button" id="btnBgmStop">BGM 停止</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <label style="margin:0;">
                <input type="checkbox" id="bgmWorkOn" checked />
                <span style="margin-left:6px;">作業中はBGMを鳴らす</span>
              </label>

              <label style="margin:0;">
                <input type="checkbox" id="bgmBreakOn" />
                <span style="margin-left:6px;">休憩中はBGMを鳴らす</span>
              </label>
            </div>

            <div class="error" id="bgmError"></div>
            <audio id="bgm" preload="none" loop></audio>
          </div>
        </details>

        <div class="row">
          <button id="btnApply" type="button">設定を適用</button>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");
  const fmtMMSS = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${pad2(m)}:${pad2(s)}`;
  };

  // =========================
  // Theme (1段階選択 / 10カテゴリ×2)
  // =========================
  const themeSelect = $("themeSelect");

  const THEMES = [
    { id:"calm_mist", label:"Calm｜癒し：ミスト", category:"Calm", vars:{
      "--bg1":"#BFE7F6","--bg2":"#D9C7FF","--card":"rgba(255,255,255,.18)","--text":"#0B1020","--muted":"rgba(11,16,32,.75)","--accent":"#2DD4BF","--accent2":"#A78BFA",
    }},
    { id:"calm_sand", label:"Calm｜癒し：サンド", category:"Calm", vars:{
      "--bg1":"#F7E7CE","--bg2":"#F3D6D6","--card":"rgba(255,255,255,.20)","--text":"#1F2937","--muted":"rgba(31,41,55,.72)","--accent":"#F59E0B","--accent2":"#FB7185",
    }},
    { id:"fresh_aqua", label:"Fresh｜爽やか：アクア", category:"Fresh", vars:{
      "--bg1":"#7DD3FC","--bg2":"#A7F3D0","--card":"rgba(255,255,255,.16)","--text":"#06203A","--muted":"rgba(6,32,58,.72)","--accent":"#0EA5E9","--accent2":"#10B981",
    }},
    { id:"fresh_ice", label:"Fresh｜爽やか：アイス", category:"Fresh", vars:{
      "--bg1":"#E0F2FE","--bg2":"#E5E7EB","--card":"rgba(255,255,255,.22)","--text":"#0F172A","--muted":"rgba(15,23,42,.70)","--accent":"#38BDF8","--accent2":"#94A3B8",
    }},
    { id:"trust_navy", label:"Trust｜信頼：ネイビー", category:"Trust", vars:{
      "--bg1":"#0F172A","--bg2":"#1F2937","--card":"rgba(255,255,255,.08)","--text":"#F8FAFC","--muted":"rgba(248,250,252,.78)","--accent":"#60A5FA","--accent2":"#94A3B8",
    }},
    { id:"trust_brick", label:"Trust｜信頼：ブリック", category:"Trust", vars:{
      "--bg1":"#111827","--bg2":"#374151","--card":"rgba(255,255,255,.09)","--text":"#F9FAFB","--muted":"rgba(249,250,251,.76)","--accent":"#B45309","--accent2":"#93C5FD",
    }},
    { id:"warm_sunset", label:"Warm｜あたたかい：サンセット", category:"Warm", vars:{
      "--bg1":"#FB923C","--bg2":"#F472B6","--card":"rgba(255,255,255,.14)","--text":"#2A0A0A","--muted":"rgba(42,10,10,.72)","--accent":"#F97316","--accent2":"#EC4899",
    }},
    { id:"warm_cocoa", label:"Warm｜あたたかい：ココア", category:"Warm", vars:{
      "--bg1":"#A16207","--bg2":"#7C2D12","--card":"rgba(255,255,255,.10)","--text":"#FFF7ED","--muted":"rgba(255,247,237,.78)","--accent":"#FBBF24","--accent2":"#FDBA74",
    }},
    { id:"pop_candy", label:"Pop｜元気：キャンディ", category:"Pop", vars:{
      "--bg1":"#22C55E","--bg2":"#06B6D4","--card":"rgba(255,255,255,.13)","--text":"#04130C","--muted":"rgba(4,19,12,.70)","--accent":"#FDE047","--accent2":"#FB7185",
    }},
    { id:"pop_tropical", label:"Pop｜元気：トロピカル", category:"Pop", vars:{
      "--bg1":"#38BDF8","--bg2":"#F97316","--card":"rgba(255,255,255,.12)","--text":"#0B1220","--muted":"rgba(11,18,32,.72)","--accent":"#A3E635","--accent2":"#F43F5E",
    }},
    { id:"retro_aqua_gold", label:"Retro｜レトロ：アクア×ゴールド", category:"Retro", vars:{
      "--bg1":"#67E8F9","--bg2":"#FDE68A","--card":"rgba(255,255,255,.18)","--text":"#1F2937","--muted":"rgba(31,41,55,.72)","--accent":"#CA8A04","--accent2":"#0EA5E9",
    }},
    { id:"retro_olive", label:"Retro｜レトロ：オリーブ", category:"Retro", vars:{
      "--bg1":"#A3A635","--bg2":"#0F766E","--card":"rgba(255,255,255,.10)","--text":"#F8FAFC","--muted":"rgba(248,250,252,.78)","--accent":"#F59E0B","--accent2":"#EAB308",
    }},
    { id:"nature_forest", label:"Nature｜自然：フォレスト", category:"Nature", vars:{
      "--bg1":"#14532D","--bg2":"#0F766E","--card":"rgba(255,255,255,.09)","--text":"#ECFDF5","--muted":"rgba(236,253,245,.78)","--accent":"#84CC16","--accent2":"#FDE047",
    }},
    { id:"nature_meadow", label:"Nature｜自然：メドウ", category:"Nature", vars:{
      "--bg1":"#A7F3D0","--bg2":"#BBF7D0","--card":"rgba(255,255,255,.20)","--text":"#052016","--muted":"rgba(5,32,22,.70)","--accent":"#22C55E","--accent2":"#10B981",
    }},
    { id:"night_indigo", label:"Night｜夜：インディゴ", category:"Night", vars:{
      "--bg1":"#111827","--bg2":"#312E81","--card":"rgba(255,255,255,.08)","--text":"#F8FAFC","--muted":"rgba(248,250,252,.76)","--accent":"#A78BFA","--accent2":"#38BDF8",
    }},
    { id:"night_aurora", label:"Night｜夜：オーロラ", category:"Night", vars:{
      "--bg1":"#020617","--bg2":"#064E3B","--card":"rgba(255,255,255,.07)","--text":"#E2E8F0","--muted":"rgba(226,232,240,.75)","--accent":"#2DD4BF","--accent2":"#84CC16",
    }},
    { id:"mono_light", label:"Mono｜モノ：ライト", category:"Mono", vars:{
      "--bg1":"#F8FAFC","--bg2":"#E5E7EB","--card":"rgba(0,0,0,.06)","--text":"#0F172A","--muted":"rgba(15,23,42,.70)","--accent":"#111827","--accent2":"#64748B",
    }},
    { id:"mono_dark", label:"Mono｜モノ：ダーク", category:"Mono", vars:{
      "--bg1":"#0B1020","--bg2":"#111827","--card":"rgba(255,255,255,.08)","--text":"#F1F5F9","--muted":"rgba(241,245,249,.76)","--accent":"#E5E7EB","--accent2":"#94A3B8",
    }},
    { id:"pastel_sakura", label:"Pastel｜パステル：さくら", category:"Pastel", vars:{
      "--bg1":"#FBCFE8","--bg2":"#E9D5FF","--card":"rgba(255,255,255,.22)","--text":"#1F2937","--muted":"rgba(31,41,55,.70)","--accent":"#FB7185","--accent2":"#A78BFA",
    }},
    { id:"pastel_lemon", label:"Pastel｜パステル：レモン", category:"Pastel", vars:{
      "--bg1":"#FEF9C3","--bg2":"#CFFAFE","--card":"rgba(255,255,255,.22)","--text":"#1F2937","--muted":"rgba(31,41,55,.70)","--accent":"#EAB308","--accent2":"#06B6D4",
    }},
  ];

  function applyTheme(themeId){
    const theme = THEMES.find(t => t.id === themeId);
    if (!theme) return;
    const root = document.documentElement;
    Object.entries(theme.vars).forEach(([k, v]) => root.style.setProperty(k, v));
  }

  function initThemeSelect(){
    if (!themeSelect) return;

    themeSelect.innerHTML = "";
    for (const t of THEMES){
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.label;
      themeSelect.appendChild(opt);
    }

    let saved = "calm_mist";
    try { saved = localStorage.getItem("pomo_theme_v2") || saved; } catch(e) {}

    if (!THEMES.some(t => t.id === saved)) saved = "calm_mist";
    themeSelect.value = saved;
    applyTheme(saved);

    themeSelect.addEventListener("change", () => {
      const id = themeSelect.value;
      applyTheme(id);
      try { localStorage.setItem("pomo_theme_v2", id); } catch(e) {}
    });
  }

  // ---------- Messages ----------
  const messageBox = $("messageBox");
  const MESSAGES = [
    "休憩は「回復」なので、サボりではありません。むしろ性能チューニングです。",
    "うまく回らない日でも、開始ボタンを押せた時点でちゃんと前に進んでます。",
    "集中は気合ではなく設計です。次の25分は“実験”にしましょう。",
    "完璧じゃなくていい。25分だけ前へ。小さく積むほど強い。",
    "止まっても戻れたらOK。中断は失敗じゃなく、調整です。",
    "休憩で回復したぶん、次の作業は軽くなります。",
    "今日はスピードより継続。静かに積み上げる日でいきましょう。",
  ];
  function setRandomMessage() {
    if (!messageBox) return;
    const i = Math.floor(Math.random() * MESSAGES.length);
    messageBox.textContent = MESSAGES[i];
  }

  // =========================
  // ★Mode Tabs (Single / AB)
  // =========================
  const leftCard = $("leftCard");
  const tabSingle = $("tabSingle");
  const tabAB = $("tabAB");

  const Mode = { SINGLE:"single", AB:"ab" };

  function setModeUI(mode){
    const isAB = (mode === Mode.AB);
    leftCard?.classList.toggle("modeAB", isAB);

    if (tabSingle){
      tabSingle.classList.toggle("active", !isAB);
      tabSingle.setAttribute("aria-selected", String(!isAB));
    }
    if (tabAB){
      tabAB.classList.toggle("active", isAB);
      tabAB.setAttribute("aria-selected", String(isAB));
    }
  }

  // ---------- Timer state ----------
  const Phase = { WORK:"work", WORK_A:"work_a", WORK_B:"work_b", BREAK:"break", LONG_BREAK:"long_break" };

  let settings = {
    mode: Mode.SINGLE,
    workMin: 25,     // SINGLE
    workAMin: 25,    // AB
    workBMin: 25,    // AB
    breakMin: 5,
    sets: 4,
    longEvery: 4,   // 0=なし
    longMin: 15,
    autoNext: true,
    presetLabel: "25/5",
  };

  let timer = {
    running: false,
    phase: Phase.WORK,
    setIndex: 1,
    remainingSec: 25*60,
    phaseTotalSec: 25*60,
    intervalId: null,
  };

  function isBreakPhase() {
    return timer.phase === Phase.BREAK || timer.phase === Phase.LONG_BREAK;
  }

  function isWorkPhase() {
    return timer.phase === Phase.WORK || timer.phase === Phase.WORK_A || timer.phase === Phase.WORK_B;
  }

  // ---------- UI ----------
  const ui = {
    preset: $("preset"),
    sets: $("sets"),
    workMin: $("workMin"),
    workAMin: $("workAMin"),
    workBMin: $("workBMin"),
    breakMin: $("breakMin"),
    longEvery: $("longEvery"),
    longMin: $("longMin"),
    autoNext: $("autoNext"),
    btnApply: $("btnApply"),

    btnStart: $("btnStart"),
    btnPause: $("btnPause"),
    btnReset: $("btnReset"),
    btnSkip: $("btnSkip"),

    presetLabel: $("presetLabel"),
    phaseDot: $("phaseDot"),
    phaseText: $("phaseText"),
    timeText: $("timeText"),
    bar: $("bar"),
    setCount: $("setCount"),
    setTotal: $("setTotal"),

    rippleWrap: $("rippleWrap"),
    rippleText: $("rippleText"),
  };

  function applySettingsToInputs(){
    ui.sets.value = settings.sets;

    if (ui.workMin) ui.workMin.value = settings.workMin;
    if (ui.workAMin) ui.workAMin.value = settings.workAMin;
    if (ui.workBMin) ui.workBMin.value = settings.workBMin;

    ui.breakMin.value = settings.breakMin;
    ui.longEvery.value = settings.longEvery;
    ui.longMin.value = settings.longMin;
    ui.autoNext.checked = settings.autoNext;

    ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
    ui.setTotal.textContent = String(settings.sets);

    setModeUI(settings.mode);
  }

  // ---------- SE (WebAudio) ----------
  const seEnabled = $("seEnabled");
  const seSelect = $("seSelect");
  const btnSeTest = $("btnSeTest");

  let audioCtx = null;
  function ensureAudioCtx(){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!audioCtx) audioCtx = new Ctx();
    if (audioCtx.state !== "running") audioCtx.resume().catch(() => {});
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function playTone({ freq=880, duration=0.12, type="sine", gain=0.08 } = {}){
    try{
      ensureAudioCtx();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();

      o.type = type;
      o.frequency.value = freq;

      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

      o.connect(g);
      g.connect(ctx.destination);

      o.start(now);
      o.stop(now + duration + 0.02);
    }catch(e){}
  }

  async function playSwitchSE(){
    if (!seEnabled?.checked) return;
    const mode = seSelect?.value || "";
    if (!mode) return;

    const breakNow = isBreakPhase();

    if (mode === "beep"){
      playTone({ freq: breakNow ? 660 : 880, duration: 0.10, type:"sine", gain:0.07 });
      return;
    }
    if (mode === "double"){
      playTone({ freq: breakNow ? 660 : 880, duration: 0.09, type:"sine", gain:0.07 });
      await sleep(120);
      playTone({ freq: breakNow ? 660 : 880, duration: 0.09, type:"sine", gain:0.07 });
      return;
    }
    if (mode === "ding"){
      playTone({ freq: breakNow ? 523 : 784, duration: 0.14, type:"triangle", gain:0.06 });
      await sleep(40);
      playTone({ freq: breakNow ? 659 : 988, duration: 0.08, type:"sine", gain:0.04 });
      return;
    }
    if (mode === "alarm"){
      for (let i=0;i<3;i++){
        playTone({ freq: 990, duration: 0.08, type:"square", gain:0.05 });
        await sleep(110);
      }
      return;
    }
  }

  if (btnSeTest) {
    btnSeTest.addEventListener("click", async () => {
      ensureAudioCtx();
      await playSwitchSE();
    });
  }

  // ---------- BGM ----------
  const bgm = $("bgm");
  if (bgm) bgm.volume = 0.2;

  const bgmSelect = $("bgmSelect");
  const bgmError = $("bgmError");
  const bgmWorkOn = $("bgmWorkOn");
  const bgmBreakOn = $("bgmBreakOn");
  const btnBgmPlay = $("btnBgmPlay");
  const btnBgmStop = $("btnBgmStop");

  function showBgmError(msg) {
    if (!bgmError) return;
    bgmError.textContent = msg;
    bgmError.classList.add("show");
  }
  function clearBgmError() {
    if (!bgmError) return;
    bgmError.textContent = "";
    bgmError.classList.remove("show");
  }

  if (bgm) {
    bgm.addEventListener("error", () => {
      const code = bgm.error?.code;
      showBgmError(
        "BGMの読み込み/再生に失敗しました。\n" +
        `url: ${bgm.currentSrc || bgm.src}\n` +
        `errorCode: ${code || "unknown"}\n` +
        "audio/フォルダの配置、ファイル名、配信環境（file://直開き等）を確認してください。"
      );
    });
  }

  function buildAudioUrl(fileName) {
    return "audio/" + encodeURIComponent(fileName);
  }

  async function setBgmSrc(fileName) {
    if (!bgm) return;
    bgm.pause();
    bgm.currentTime = 0;

    if (!fileName) {
      bgm.removeAttribute("src");
      bgm.load();
      clearBgmError();
      return;
    }
    const url = buildAudioUrl(fileName);
    clearBgmError();
    bgm.src = url;
    bgm.load();
  }

  let audioUnlocked = false;
  async function unlockAudioOnce(){
    if (!bgm || audioUnlocked) return;
    try{
      bgm.muted = true;
      const p = bgm.play();
      if (p && typeof p.then === "function") await p;
      bgm.pause();
      bgm.currentTime = 0;
      bgm.muted = false;

      audioUnlocked = true;
    }catch(e){
      bgm.muted = false;
      audioUnlocked = false;
    }
  }

  async function playBgmNow(){
    if (!bgm || !bgmSelect?.value) return;
    try{
      await bgm.play();
      clearBgmError();
    }catch(e){
      showBgmError(
        "BGMを再生できませんでした。\n" +
        "ブラウザの自動再生制限により、最初は「開始」などの操作が必要です。"
      );
    }
  }

  function stopBgmNow(){
    if (!bgm) return;
    bgm.pause();
    bgm.currentTime = 0;
  }

  async function syncBgmForPhase(){
    if (!bgm || !bgmSelect) return;

    if (!bgmSelect.value){
      stopBgmNow();
      return;
    }

    const shouldPlay = isBreakPhase() ? !!bgmBreakOn?.checked : !!bgmWorkOn?.checked;
    if (!shouldPlay){
      stopBgmNow();
      return;
    }

    const nextUrl = buildAudioUrl(bgmSelect.value);
    const nextAbs = new URL(nextUrl, location.href).href;
    const curAbs = bgm.currentSrc || bgm.src || "";
    if (curAbs !== nextAbs) await setBgmSrc(bgmSelect.value);

    await playBgmNow();
  }

  if (bgmSelect){
    bgmSelect.addEventListener("change", async () => {
      await unlockAudioOnce();
      await setBgmSrc(bgmSelect.value);
      await syncBgmForPhase();
    });
  }
  if (bgmWorkOn) bgmWorkOn.addEventListener("change", () => syncBgmForPhase());
  if (bgmBreakOn) bgmBreakOn.addEventListener("change", () => syncBgmForPhase());

  if (btnBgmPlay){
    btnBgmPlay.addEventListener("click", async () => {
      await unlockAudioOnce();
      if (bgmSelect.value) await setBgmSrc(bgmSelect.value);
      await playBgmNow();
    });
  }
  if (btnBgmStop){
    btnBgmStop.addEventListener("click", () => {
      stopBgmNow();
      clearBgmError();
    });
  }

  // =========================
  // Timer core (Single / AB)
  // =========================
  function phaseToLabel(phase){
    if (phase === Phase.WORK) return "作業";
    if (phase === Phase.WORK_A) return "作業A";
    if (phase === Phase.WORK_B) return "作業B";
    if (phase === Phase.BREAK) return "休憩";
    return "長休憩";
  }

  function getPhaseTotalSec(phase){
    if (phase === Phase.WORK) return settings.workMin * 60;
    if (phase === Phase.WORK_A) return settings.workAMin * 60;
    if (phase === Phase.WORK_B) return settings.workBMin * 60;
    if (phase === Phase.BREAK) return settings.breakMin * 60;
    return settings.longMin * 60;
  }

  function updateRippleUI(){
    ui.rippleWrap.classList.toggle("rippleOn", isBreakPhase());
    ui.rippleWrap.setAttribute("aria-hidden", isBreakPhase() ? "false" : "true");

    if (timer.phase === Phase.BREAK) {
      ui.rippleText.textContent = "休憩中：肩を落として、呼吸をひとつ。";
    } else if (timer.phase === Phase.LONG_BREAK) {
      ui.rippleText.textContent = "長休憩：水分補給。目を遠くに。";
    } else {
      ui.rippleText.textContent = "";
    }
  }

  function updatePhaseUI(){
    const breakMode = isBreakPhase();
    ui.phaseDot.classList.toggle("break", breakMode);
    ui.bar.classList.toggle("break", breakMode);

    ui.phaseText.textContent = phaseToLabel(timer.phase);

    ui.setCount.textContent = String(timer.setIndex);
    ui.timeText.textContent = fmtMMSS(timer.remainingSec);

    const pct = timer.phaseTotalSec > 0
      ? ((timer.phaseTotalSec - timer.remainingSec) / timer.phaseTotalSec) * 100
      : 0;
    ui.bar.style.width = `${Math.min(100, Math.max(0, pct))}%`;

    document.title = `${ui.phaseText.textContent} ${fmtMMSS(timer.remainingSec)} - ポモドーロ`;
    updateRippleUI();
  }

  function setButtons(){
    ui.btnStart.disabled = timer.running;
    ui.btnPause.disabled = !timer.running;
  }

  function stopInterval(){
    if (timer.intervalId){
      clearInterval(timer.intervalId);
      timer.intervalId = null;
    }
    timer.running = false;
    setButtons();
  }

  function startInterval(){
    if (timer.running) return;
    timer.running = true;
    setButtons();

    timer.intervalId = setInterval(async () => {
      timer.remainingSec -= 1;
      if (timer.remainingSec <= 0){
        timer.remainingSec = 0;
        updatePhaseUI();
        await onPhaseComplete();
      } else {
        updatePhaseUI();
      }
    }, 1000);
  }

  function resetToPhase(phase){
    timer.phase = phase;
    timer.phaseTotalSec = getPhaseTotalSec(phase);
    timer.remainingSec = timer.phaseTotalSec;
    updatePhaseUI();
  }

  function resetAll(){
    stopInterval();
    timer.setIndex = 1;
    // モードに応じて初期フェーズを決める
    resetToPhase(settings.mode === Mode.AB ? Phase.WORK_A : Phase.WORK);
  }

  function isLongBreakDue(){
    if (settings.longEvery <= 0) return false;
    return (timer.setIndex % settings.longEvery) === 0;
  }

  function nextAfterWork(){
    // SINGLE: WORK -> (BREAK|LONG)
    if (settings.mode === Mode.SINGLE) {
      return isLongBreakDue() ? Phase.LONG_BREAK : Phase.BREAK;
    }
    // AB: WORK_A -> WORK_B -> (BREAK|LONG)
    if (timer.phase === Phase.WORK_A) return Phase.WORK_B;
    return isLongBreakDue() ? Phase.LONG_BREAK : Phase.BREAK;
  }

  async function onPhaseComplete(){
    stopInterval();
    setRandomMessage();

    if (isWorkPhase()){
      resetToPhase(nextAfterWork());
    } else {
      timer.setIndex = (timer.setIndex < settings.sets) ? (timer.setIndex + 1) : 1;
      resetToPhase(settings.mode === Mode.AB ? Phase.WORK_A : Phase.WORK);
    }

    ensureAudioCtx();
    await playSwitchSE();
    await syncBgmForPhase();

    if (settings.autoNext) startInterval();
  }

  function skipPhase(){
    timer.remainingSec = 0;
    updatePhaseUI();
    onPhaseComplete();
  }

  // ---------- Presets ----------
  function parsePresetValue(v){
    const [w,b,s,l] = v.split("_").map(x => parseInt(x, 10));
    return { workMin:w, breakMin:b, sets:s, longEvery:s, longMin:l };
  }

  function applyPreset(value){
    if (value === "custom"){
      settings.presetLabel = "Custom";
      ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
      return;
    }
    const p = parsePresetValue(value);

    // SINGLEはworkMinに、ABは「A/Bも同じ値」に寄せる（挙動が分かりやすい）
    settings.workMin = p.workMin;
    settings.workAMin = p.workMin;
    settings.workBMin = p.workMin;

    settings.breakMin = p.breakMin;
    settings.sets = p.sets;
    settings.longEvery = p.longEvery;
    settings.longMin = p.longMin;
    settings.presetLabel = `${p.workMin}/${p.breakMin}`;

    applySettingsToInputs();
    if (!timer.running) resetAll();
  }

  function readSettingsFromInputs(){
    const sets = Math.max(1, Math.min(12, parseInt(ui.sets.value,10) || 4));
    const breakMin = Math.max(1, Math.min(60, parseInt(ui.breakMin.value,10) || 5));
    const longEvery = Math.max(0, Math.min(12, parseInt(ui.longEvery.value,10) || 0));
    const longMin = Math.max(1, Math.min(120, parseInt(ui.longMin.value,10) || 15));

    const workMin = ui.workMin ? Math.max(1, Math.min(180, parseInt(ui.workMin.value,10) || 25)) : 25;
    const workAMin = ui.workAMin ? Math.max(1, Math.min(180, parseInt(ui.workAMin.value,10) || 25)) : 25;
    const workBMin = ui.workBMin ? Math.max(1, Math.min(180, parseInt(ui.workBMin.value,10) || 25)) : 25;

    settings.sets = sets;
    settings.breakMin = breakMin;
    settings.longEvery = longEvery;
    settings.longMin = longMin;

    settings.workMin = workMin;
    settings.workAMin = workAMin;
    settings.workBMin = workBMin;

    settings.autoNext = ui.autoNext.checked;

    // 表示ラベルは SINGLE寄りの「代表値」として持たせる
    // ABのときも、表示上はA/Bの合計にしてもよいが、既存UIを崩さないためここでは workMin 相当の表記に固定
    if (settings.mode === Mode.AB){
      settings.presetLabel = `${settings.workAMin}+${settings.workBMin}/${settings.breakMin}`;
    } else {
      settings.presetLabel = `${settings.workMin}/${settings.breakMin}`;
    }
  }

  // =========================
  // Events
  // =========================
  ui.preset.addEventListener("change", () => applyPreset(ui.preset.value));

  ui.btnApply.addEventListener("click", async () => {
    readSettingsFromInputs();
    applySettingsToInputs();
    if (!timer.running) resetAll();
    await syncBgmForPhase();
  });

  ui.btnStart.addEventListener("click", async () => {
    ensureAudioCtx();
    await unlockAudioOnce();
    await syncBgmForPhase();
    startInterval();
  });

  ui.btnPause.addEventListener("click", () => stopInterval());
  ui.btnReset.addEventListener("click", () => resetAll());
  ui.btnSkip.addEventListener("click", () => skipPhase());

  // ★タブ：モード切替
  function saveMode(mode){
    try { localStorage.setItem("pomo_mode_v1", mode); } catch(e) {}
  }
  function loadMode(){
    let saved = Mode.SINGLE;
    try { saved = localStorage.getItem("pomo_mode_v1") || saved; } catch(e) {}
    if (saved !== Mode.SINGLE && saved !== Mode.AB) saved = Mode.SINGLE;
    settings.mode = saved;
    setModeUI(saved);
  }
  function switchMode(mode){
    if (timer.running) return; // 誤操作防止：稼働中は切替不可（必要なら外してください）
    settings.mode = mode;
    saveMode(mode);
    applySettingsToInputs();
    resetAll();
    setRandomMessage();
  }

  if (tabSingle) tabSingle.addEventListener("click", () => switchMode(Mode.SINGLE));
  if (tabAB) tabAB.addEventListener("click", () => switchMode(Mode.AB));

  // ---------- Init ----------
  (function init(){
    initThemeSelect();

    loadMode();
    // 初期タブUI
    setModeUI(settings.mode);

    applySettingsToInputs();
    resetAll();
    setButtons();
    setRandomMessage();
    if (bgmSelect?.value) setBgmSrc(bgmSelect.value);

    // 初期タブ active 反映
    // （loadMode後に確実に反映）
    setModeUI(settings.mode);
  })();

})();
</script>
</body>
</html>
