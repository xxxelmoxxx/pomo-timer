<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼</title>

<link rel="icon" href="favicon.png" type="image/png">
<link rel="apple-touch-icon" href="favicon.png">

<style>
  :root{
    /* Theme variables (JSã§ä¸Šæ›¸ãã•ã‚Œã‚‹) */
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text:#ffffff;
    --muted: rgba(255,255,255,.88);
    --accent:#38bdf8;
    --accent2:#a78bfa;

    /* Common (ãƒ†ãƒ¼ãƒã«ä¾å­˜ã•ã›ãªã„) */
    --break:#22c55e;
    --start1:#22c55e;
    --start2:#16a34a;
    --stop1:#6b7280;
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);
    --radius: 18px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 18px;
  }

  .wrap{
    width: min(980px, 100%);
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap: 16px;
  }
  @media (max-width: 860px){
    .wrap{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--card);
    border: 1px solid rgba(255,255,255,.18);
    border-radius: var(--radius);
    box-shadow: 0 14px 40px var(--shadow);
    padding: 18px;
    backdrop-filter: blur(8px);
  }

  .header{
    display:flex;
    justify-content:space-between;
    gap: 12px;
    align-items:flex-start;
    margin-bottom: 10px;
  }

  h1{ margin:0; font-size: 18px; letter-spacing:.02em; }
  .sub{ margin-top:6px; color: var(--muted); font-size: 13px; line-height: 1.5; }

  .pill{
    background: rgba(255,255,255,.16);
    border: 1px solid rgba(255,255,255,.18);
    padding: 8px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
  .phaseRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top: 10px; }
  .phaseTag{
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 10px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: var(--muted);
    font-size: 12px;
  }
  .dot{ width:10px; height:10px; border-radius:999px; background: var(--accent); box-shadow: 0 0 12px rgba(56,189,248,.7); }
  .dot.break{ background: var(--break); box-shadow: 0 0 12px rgba(34,197,94,.65); }

  .bigTime{
    font-variant-numeric: tabular-nums;
    font-size: 64px;
    text-align:center;
    margin: 12px 0 10px;
    letter-spacing: .02em;
  }

  .progress{
    width:100%;
    height: 14px;
    background: rgba(255,255,255,.16);
    border-radius: 999px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.18);
  }
  .bar{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(14,165,233,.85));
    border-radius: 999px;
    transition: width .25s linear;
  }
  .bar.break{
    background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(22,163,74,.85));
  }

  .controls{
    display:flex; flex-wrap:wrap; gap: 10px;
    justify-content:center; margin-top: 12px;
  }

  button{
    border:0;
    padding: 12px 14px;
    border-radius: 12px;
    cursor:pointer;
    color: var(--text);
    font-weight: 650;
    letter-spacing:.02em;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.18);
  }
  .primary{ background: linear-gradient(135deg, var(--start1), var(--start2)); }
  .secondary{ background: linear-gradient(135deg, var(--stop1), var(--stop2)); }
  .warn{ background: linear-gradient(135deg, #f59e0b, #d97706); }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  /* å³å´è¨­å®š */
  label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  select, input[type="number"]{
    width:100%;
    padding: 12px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.18);
    color: var(--text);
    outline:none;
  }
  optgroup{ color: rgba(255,255,255,.92); font-weight: 800; }
  option{ color: #ffffff; }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

  .switch{
    display:flex; align-items:center; gap: 10px;
    padding: 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.16);
  }
  .switch input{ transform: scale(1.2); }

  .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }

  .hint{ color: var(--muted); font-size: 12px; line-height: 1.6; margin-top: 10px; }

  /* ä¼‘æ†©ä¸­ã ã‘æ³¢ç´‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .rippleWrap{
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-top: 6px;
    height: 140px;
  }
  .ripple{
    position:absolute;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    opacity: 0;
    border: 2px solid rgba(34,197,94,.65);
    box-shadow: 0 0 18px rgba(34,197,94,.25);
  }
  .rippleOn .ripple{
    opacity: 1;
    animation: ripple 2.6s ease-out infinite;
  }
  .rippleOn .ripple.r2{ animation-delay: .8s; }
  .rippleOn .ripple.r3{ animation-delay: 1.6s; }

  @keyframes ripple{
    0%   { transform: scale(1);   opacity: .0; }
    15%  { opacity: .65; }
    100% { transform: scale(14); opacity: 0; }
  }

  .rippleText{
    z-index: 2;
    color: rgba(255,255,255,.92);
    font-size: 13px;
    text-align:center;
    line-height: 1.5;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.14);
  }

  .messageCard{
    margin-top: 14px;
    padding: 14px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.20);
    box-shadow: 0 10px 24px rgba(0,0,0,.12);
    font-size: 15px;
    line-height: 1.8;
    color: rgba(255,255,255,.95);
  }
  @media (max-width: 860px){
    .messageCard{ font-size: 16px; }
  }

  details.panel{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.08);
    border-radius: 12px;
    padding: 10px 10px;
  }
  details.panel > summary{
    cursor: pointer;
    list-style: none;
    font-weight: 650;
    color: rgba(255,255,255,.92);
    outline: none;
  }
  details.panel > summary::-webkit-details-marker{ display:none; }
  details.panel .inner{ margin-top: 10px; }

  .compact{ padding: 14px; }
  .compact .grid{ gap: 10px; }
  .compact label{ margin-bottom: 4px; }
  .compact select, .compact input[type="number"]{ padding: 10px 10px; border-radius: 10px; }
  .compact .switch{ padding: 10px; border-radius: 12px; }
  .compact .hint{ margin-top: 6px; line-height: 1.5; }
  .compact button{ padding: 10px 12px; border-radius: 10px; }

  .error{
    margin-top: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: rgba(255,255,255,.92);
    font-size: 12px;
    line-height: 1.55;
    display:none;
    white-space: pre-wrap;
  }
  .error.show{ display:block; }

  /* ãƒ¢ãƒ¼ãƒ‰ã‚¿ãƒ–ï¼ˆSimple / Dualï¼‰ */
  .tabs{
    display:flex;
    gap:10px;
    margin: 6px 0 12px;
    flex-wrap:wrap;
  }
  .tabBtn{
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.12);
    border: 1px solid rgba(255,255,255,.18);
    color: rgba(255,255,255,.92);
    font-weight: 700;
    font-size: 12px;
    cursor:pointer;
  }
  .tabBtn.active{
    background: rgba(0,0,0,.18);
    border-color: rgba(255,255,255,.26);
  }
  .dualOnly{ display:none; }
  .dualMode .dualOnly{ display:block; }
  .dualMode .simpleOnly{ display:none; }

  /* ===== BGM æ“ä½œãƒãƒ¼ ===== */
  .audioBar{
    display:flex;
    align-items:center;
    gap:10px;
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(0,0,0,.12);
    border: 1px solid rgba(255,255,255,.18);
  }
  .abBtn{
    width: 38px;
    height: 38px;
    border-radius: 999px;
    display:grid;
    place-items:center;
    padding: 0;
    font-weight: 900;
    line-height: 1;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.18);
  }
  .abTime{
    font-variant-numeric: tabular-nums;
    color: var(--muted);
    font-size: 12px;
    white-space: nowrap;
  }
  .abSep{ opacity: .7; margin: 0 2px; }
  .abSeek{
    flex: 1 1 auto;
    min-width: 120px;
    height: 8px;
    background: rgba(255,255,255,.18);
    border-radius: 999px;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
  }
  .abSeek::-webkit-slider-thumb{
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 999px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(0,0,0,.18);
  }
  .abSeek::-moz-range-thumb{
    width: 16px; height: 16px;
    border-radius: 999px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(0,0,0,.18);
  }
  .abVolWrap{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .abVolIcon{
    font-size: 14px;
    opacity: .9;
  }
  .abVol{
    width: 110px;
    height: 8px;
    background: rgba(255,255,255,.18);
    border-radius: 999px;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
  }
  .abVol::-webkit-slider-thumb{
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 999px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(0,0,0,.18);
  }
  .abVol::-moz-range-thumb{
    width: 14px; height: 14px;
    border-radius: 999px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(0,0,0,.18);
  }
  @media (max-width: 860px){
    .abVol{ width: 90px; }
  }
</style>
</head>

<body>
  <div class="wrap">
    <!-- Left: Timer -->
    <section class="card compact">
      <div class="header">
        <div>
          <h1>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼</h1>
        </div>
        <div class="pill" id="presetLabel">Preset: 25/5</div>
      </div>

      <div class="phaseRow">
        <div class="phaseTag"><span class="dot" id="phaseDot"></span><span id="phaseText">ä½œæ¥­</span></div>
        <div class="pill">ã‚»ãƒƒãƒˆ: <span id="setCount">1</span> / <span id="setTotal">4</span></div>
      </div>

      <div class="bigTime" id="timeText">25:00</div>

      <div class="progress" aria-label="progress">
        <div class="bar" id="bar"></div>
      </div>

      <!-- ä¼‘æ†©ä¸­ã ã‘æ³¢ç´‹ -->
      <div class="rippleWrap" id="rippleWrap" aria-hidden="true">
        <div class="ripple r1"></div>
        <div class="ripple r2"></div>
        <div class="ripple r3"></div>
        <div class="rippleText" id="rippleText">ä¼‘æ†©ä¸­ï¼šè‚©ã‚’è½ã¨ã—ã¦ã€å‘¼å¸ã‚’ã²ã¨ã¤ã€‚</div>
      </div>

      <div class="controls">
        <button class="primary" id="btnStart">é–‹å§‹</button>
        <button class="secondary" id="btnPause" disabled>ä¸€æ™‚åœæ­¢</button>
        <button id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="warn" id="btnSkip">æ¬¡ã¸</button>
      </div>

      <div class="messageCard" id="messageBox"></div>
    </section>

    <!-- Right: Settings + BGM -->
    <section class="card compact" id="settingsCard">
      <div class="header">
        <div>
          <h1>è¨­å®š / BGM</h1>
          <div class="sub">ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒ–ï¼‰ã§ã€Œä½œæ¥­ï¼‹ä¼‘æ†©ã€ã‹ã€Œä½œæ¥­Aï¼‹ä½œæ¥­Bï¼‹ä¼‘æ†©ã€ã‚’åˆ‡æ›¿ã€‚ãƒ†ãƒ¼ãƒã¯1ã¤ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸æŠã§ãã¾ã™ã€‚</div>
        </div>
      </div>

      <!-- ãƒ¢ãƒ¼ãƒ‰ã‚¿ãƒ– -->
      <div class="tabs">
        <button class="tabBtn" id="tabSimple" type="button">ä½œæ¥­ ã¨ ä¼‘æ†©</button>
        <button class="tabBtn" id="tabDual" type="button">ä½œæ¥­A / ä½œæ¥­B / ä¼‘æ†©</button>
      </div>

      <!-- ãƒ†ãƒ¼ãƒï¼š1å›ã§é¸æŠï¼ˆã‚«ãƒ†ã‚´ãƒªè¦‹å‡ºã—ã¤ãï¼‰ -->
      <div style="margin-bottom:12px;">
        <label for="themeSelect">ãƒ†ãƒ¼ãƒ</label>
        <select id="themeSelect"></select>
      </div>

      <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆ/æ™‚é–“ -->
      <div class="grid">
        <div>
          <label for="preset">ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
          <select id="preset">
            <option value="25_5_4_15">æ¨™æº– 25/5ï¼ˆ4ã‚»ãƒƒãƒˆã”ã¨ã«é•·ä¼‘æ†©15ï¼‰</option>
            <option value="50_10_2_20">æ·±é›†ä¸­ 50/10ï¼ˆ2ã‚»ãƒƒãƒˆã”ã¨ã«é•·ä¼‘æ†©20ï¼‰</option>
            <option value="45_15_2_30">ã—ã£ã‹ã‚Š 45/15ï¼ˆ2ã‚»ãƒƒãƒˆã”ã¨ã«é•·ä¼‘æ†©30ï¼‰</option>
            <option value="15_5_4_10">å…¥é–€ 15/5ï¼ˆ4ã‚»ãƒƒãƒˆã”ã¨ã«é•·ä¼‘æ†©10ï¼‰</option>
            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
          </select>
        </div>

        <div>
          <label for="sets">1ã‚µã‚¤ã‚¯ãƒ«ã®ã‚»ãƒƒãƒˆæ•°</label>
          <input id="sets" type="number" min="1" max="12" value="4" />
        </div>

        <div class="simpleOnly">
          <label for="workMin">ä½œæ¥­ï¼ˆåˆ†ï¼‰</label>
          <input id="workMin" type="number" min="1" max="180" value="25" />
        </div>

        <div class="dualOnly">
          <label for="workAMin">ä½œæ¥­Aï¼ˆåˆ†ï¼‰</label>
          <input id="workAMin" type="number" min="1" max="180" value="25" />
        </div>
        <div class="dualOnly">
          <label for="workBMin">ä½œæ¥­Bï¼ˆåˆ†ï¼‰</label>
          <input id="workBMin" type="number" min="1" max="180" value="25" />
        </div>

        <div>
          <label for="breakMin">ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label>
          <input id="breakMin" type="number" min="1" max="60" value="5" />
        </div>

        <div>
          <label for="longEvery">é•·ä¼‘æ†©ã®é »åº¦ï¼ˆä½•ã‚»ãƒƒãƒˆã”ã¨ï¼‰</label>
          <input id="longEvery" type="number" min="0" max="12" value="4" />
        </div>

        <div>
          <label for="longMin">é•·ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label>
          <input id="longMin" type="number" min="1" max="120" value="15" />
        </div>
      </div>

      <div style="margin-top:12px; display:grid; gap:10px;">
        <div class="switch">
          <input id="autoNext" type="checkbox" checked />
          <div>
            <div style="font-weight:650;">è‡ªå‹•ã§æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã¸</div>
            <div class="hint" style="margin:6px 0 0;">ONã ã¨ã€0ç§’ã§ãƒ•ã‚§ãƒ¼ã‚ºã‚’è‡ªå‹•åˆ‡æ›¿</div>
          </div>
        </div>

        <details class="panel" open>
          <summary>ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿ã‚µã‚¦ãƒ³ãƒ‰</summary>
          <div class="inner">
            <div class="row" style="gap:12px; align-items:center;">
              <label style="margin:0; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="seEnabled" checked />
                <span>åˆ‡æ›¿ã‚µã‚¦ãƒ³ãƒ‰ã‚’é³´ã‚‰ã™</span>
              </label>
              <button type="button" id="btnSeTest">éŸ³ãƒ†ã‚¹ãƒˆ</button>
            </div>

            <div style="margin-top:10px;">
              <label for="seSelect">éŸ³ã®ç¨®é¡</label>
              <select id="seSelect">
                <option value="beep">ãƒ”ãƒƒï¼ˆçŸ­ï¼‰</option>
                <option value="double">ãƒ”ãƒ”ï¼ˆ2å›ï¼‰</option>
                <option value="ding">ãƒãƒ³ï¼ˆæŸ”ã‚‰ã‹ï¼‰</option>
                <option value="alarm">ãƒ”ãƒ”ãƒ”ï¼ˆå¼·ã‚ï¼‰</option>
              </select>
            </div>

            <div class="hint" style="margin-top:10px;">
              æ³¨æ„ï¼šãƒ–ãƒ©ã‚¦ã‚¶ä»•æ§˜ã§ã€æœ€åˆã®éŸ³å‡ºã—ã¯ã€Œé–‹å§‹ã€ãªã©ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™ã€‚
            </div>
          </div>
        </details>

        <details class="panel" open>
          <summary>BGM</summary>
          <div class="inner">
            <div>
              <label for="bgmSelect">BGMï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</label>
              <select id="bgmSelect">
                <option value="">ãªã—</option>
              </select>
            </div>

            <!-- BGM æ“ä½œãƒãƒ¼ -->
            <div class="audioBar" id="bgmBar" aria-label="BGMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼" style="margin-top:10px;">
              <button type="button" class="abBtn" id="btnBgmToggle" aria-label="å†ç”Ÿ/åœæ­¢">â–¶</button>

              <div class="abTime" aria-label="å†ç”Ÿä½ç½®">
                <span id="bgmCur">0:00</span>
                <span class="abSep">/</span>
                <span id="bgmDur">0:00</span>
              </div>

              <input id="bgmSeek" class="abSeek" type="range" min="0" max="1000" value="0" step="1" aria-label="ã‚·ãƒ¼ã‚¯" />

              <div class="abVolWrap" aria-label="éŸ³é‡">
                <span class="abVolIcon">ğŸ”Š</span>
                <input id="bgmVol" class="abVol" type="range" min="0" max="1" value="0.2" step="0.01" aria-label="éŸ³é‡" />
              </div>
            </div>

            <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆBGMãƒãƒ¼ã®ä¸‹ã¸ï¼‰ -->
            <div class="row" style="margin-top:10px;">
              <label style="margin:0;">
                <input type="checkbox" id="bgmWorkOn" checked />
                <span style="margin-left:6px;">ä½œæ¥­ä¸­ã¯BGMã‚’é³´ã‚‰ã™</span>
              </label>

              <label style="margin:0;">
                <input type="checkbox" id="bgmBreakOn" />
                <span style="margin-left:6px;">ä¼‘æ†©ä¸­ã¯BGMã‚’é³´ã‚‰ã™</span>
              </label>
            </div>

            <div class="error" id="bgmError"></div>
            <audio id="bgm" preload="none" loop></audio>

          </div>
        </details>

        <div class="row">
          <button id="btnApply" type="button">è¨­å®šã‚’é©ç”¨</button>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  "use strict";

  const $ = (id) => document.getElementById(id);

  const pad2 = (n) => String(n).padStart(2, "0");
  const fmtMMSS = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${pad2(m)}:${pad2(s)}`;
  };
  const fmtMSS = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${m}:${pad2(s)}`;
  };

  // =========================
  // THEMES (ã‚«ãƒ†ã‚´ãƒªÃ—ãƒ†ãƒ¼ãƒ)
  // =========================
  const THEMES = [
    { id:"calm_mist", label:"ç™’ã—ï¼šãƒŸã‚¹ãƒˆ", category:"Calm", vars:{
      "--bg1":"#BFE7F6","--bg2":"#D9C7FF","--card":"rgba(255,255,255,.18)","--text":"#0B1020","--muted":"rgba(11,16,32,.75)","--accent":"#2DD4BF","--accent2":"#A78BFA"
    }},
    { id:"calm_sand", label:"ç™’ã—ï¼šã‚µãƒ³ãƒ‰", category:"Calm", vars:{
      "--bg1":"#F7E7CE","--bg2":"#F3D6D6","--card":"rgba(255,255,255,.20)","--text":"#1F2937","--muted":"rgba(31,41,55,.72)","--accent":"#F59E0B","--accent2":"#FB7185"
    }},

    { id:"fresh_aqua", label:"çˆ½ã‚„ã‹ï¼šã‚¢ã‚¯ã‚¢", category:"Fresh", vars:{
      "--bg1":"#7DD3FC","--bg2":"#A7F3D0","--card":"rgba(255,255,255,.16)","--text":"#06203A","--muted":"rgba(6,32,58,.72)","--accent":"#0EA5E9","--accent2":"#10B981"
    }},
    { id:"fresh_ice", label:"çˆ½ã‚„ã‹ï¼šã‚¢ã‚¤ã‚¹", category:"Fresh", vars:{
      "--bg1":"#E0F2FE","--bg2":"#E5E7EB","--card":"rgba(255,255,255,.22)","--text":"#0F172A","--muted":"rgba(15,23,42,.70)","--accent":"#38BDF8","--accent2":"#94A3B8"
    }},

    { id:"trust_navy", label:"ä¿¡é ¼ï¼šãƒã‚¤ãƒ“ãƒ¼", category:"Trust", vars:{
      "--bg1":"#0F172A","--bg2":"#1F2937","--card":"rgba(255,255,255,.08)","--text":"#F8FAFC","--muted":"rgba(248,250,252,.78)","--accent":"#60A5FA","--accent2":"#94A3B8"
    }},
    { id:"trust_brick", label:"ä¿¡é ¼ï¼šãƒ–ãƒªãƒƒã‚¯", category:"Trust", vars:{
      "--bg1":"#111827","--bg2":"#374151","--card":"rgba(255,255,255,.09)","--text":"#F9FAFB","--muted":"rgba(249,250,251,.76)","--accent":"#B45309","--accent2":"#93C5FD"
    }},

    { id:"warm_sunset", label:"ã‚ãŸãŸã‹ã„ï¼šã‚µãƒ³ã‚»ãƒƒãƒˆ", category:"Warm", vars:{
      "--bg1":"#FB923C","--bg2":"#F472B6","--card":"rgba(255,255,255,.14)","--text":"#2A0A0A","--muted":"rgba(42,10,10,.72)","--accent":"#F97316","--accent2":"#EC4899"
    }},
    { id:"warm_cocoa", label:"ã‚ãŸãŸã‹ã„ï¼šã‚³ã‚³ã‚¢", category:"Warm", vars:{
      "--bg1":"#A16207","--bg2":"#7C2D12","--card":"rgba(255,255,255,.10)","--text":"#FFF7ED","--muted":"rgba(255,247,237,.78)","--accent":"#FBBF24","--accent2":"#FDBA74"
    }},

    { id:"pop_candy", label:"å…ƒæ°—ï¼šã‚­ãƒ£ãƒ³ãƒ‡ã‚£", category:"Pop", vars:{
      "--bg1":"#22C55E","--bg2":"#06B6D4","--card":"rgba(255,255,255,.13)","--text":"#04130C","--muted":"rgba(4,19,12,.70)","--accent":"#FDE047","--accent2":"#FB7185"
    }},
    { id:"pop_tropical", label:"å…ƒæ°—ï¼šãƒˆãƒ­ãƒ”ã‚«ãƒ«", category:"Pop", vars:{
      "--bg1":"#38BDF8","--bg2":"#F97316","--card":"rgba(255,255,255,.12)","--text":"#0B1220","--muted":"rgba(11,18,32,.72)","--accent":"#A3E635","--accent2":"#F43F5E"
    }},

    { id:"retro_aqua_gold", label:"ãƒ¬ãƒˆãƒ­ï¼šã‚¢ã‚¯ã‚¢Ã—ã‚´ãƒ¼ãƒ«ãƒ‰", category:"Retro", vars:{
      "--bg1":"#67E8F9","--bg2":"#FDE68A","--card":"rgba(255,255,255,.18)","--text":"#1F2937","--muted":"rgba(31,41,55,.72)","--accent":"#CA8A04","--accent2":"#0EA5E9"
    }},
    { id:"retro_olive", label:"ãƒ¬ãƒˆãƒ­ï¼šã‚ªãƒªãƒ¼ãƒ–", category:"Retro", vars:{
      "--bg1":"#A3A635","--bg2":"#0F766E","--card":"rgba(255,255,255,.10)","--text":"#F8FAFC","--muted":"rgba(248,250,252,.78)","--accent":"#F59E0B","--accent2":"#EAB308"
    }},

    { id:"nature_forest", label:"è‡ªç„¶ï¼šãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ", category:"Nature", vars:{
      "--bg1":"#14532D","--bg2":"#0F766E","--card":"rgba(255,255,255,.09)","--text":"#ECFDF5","--muted":"rgba(236,253,245,.78)","--accent":"#84CC16","--accent2":"#FDE047"
    }},
    { id:"nature_meadow", label:"è‡ªç„¶ï¼šãƒ¡ãƒ‰ã‚¦", category:"Nature", vars:{
      "--bg1":"#A7F3D0","--bg2":"#BBF7D0","--card":"rgba(255,255,255,.20)","--text":"#052016","--muted":"rgba(5,32,22,.70)","--accent":"#22C55E","--accent2":"#10B981"
    }},

    { id:"night_indigo", label:"å¤œï¼šã‚¤ãƒ³ãƒ‡ã‚£ã‚´", category:"Night", vars:{
      "--bg1":"#111827","--bg2":"#312E81","--card":"rgba(255,255,255,.08)","--text":"#F8FAFC","--muted":"rgba(248,250,252,.76)","--accent":"#A78BFA","--accent2":"#38BDF8"
    }},
    { id:"night_aurora", label:"å¤œï¼šã‚ªãƒ¼ãƒ­ãƒ©", category:"Night", vars:{
      "--bg1":"#020617","--bg2":"#064E3B","--card":"rgba(255,255,255,.07)","--text":"#E2E8F0","--muted":"rgba(226,232,240,.75)","--accent":"#2DD4BF","--accent2":"#84CC16"
    }},

    { id:"mono_light", label:"ãƒ¢ãƒï¼šãƒ©ã‚¤ãƒˆ", category:"Mono", vars:{
      "--bg1":"#F8FAFC","--bg2":"#E5E7EB","--card":"rgba(0,0,0,.06)","--text":"#0F172A","--muted":"rgba(15,23,42,.70)","--accent":"#111827","--accent2":"#64748B"
    }},
    { id:"mono_dark", label:"ãƒ¢ãƒï¼šãƒ€ãƒ¼ã‚¯", category:"Mono", vars:{
      "--bg1":"#0B1020","--bg2":"#111827","--card":"rgba(255,255,255,.08)","--text":"#F1F5F9","--muted":"rgba(241,245,249,.76)","--accent":"#E5E7EB","--accent2":"#94A3B8"
    }},

    { id:"pastel_sakura", label:"ãƒ‘ã‚¹ãƒ†ãƒ«ï¼šã•ãã‚‰", category:"Pastel", vars:{
      "--bg1":"#FBCFE8","--bg2":"#E9D5FF","--card":"rgba(255,255,255,.22)","--text":"#1F2937","--muted":"rgba(31,41,55,.70)","--accent":"#FB7185","--accent2":"#A78BFA"
    }},
    { id:"pastel_lemon", label:"ãƒ‘ã‚¹ãƒ†ãƒ«ï¼šãƒ¬ãƒ¢ãƒ³", category:"Pastel", vars:{
      "--bg1":"#FEF9C3","--bg2":"#CFFAFE","--card":"rgba(255,255,255,.22)","--text":"#1F2937","--muted":"rgba(31,41,55,.70)","--accent":"#EAB308","--accent2":"#06B6D4"
    }},
  ];

  const CATEGORY_LABEL = {
    Calm:   "Calm / ç™’ã—ï¼ˆã‚„ã‚ã‚‰ã‹ã„ãƒ»è½ã¡ç€ãï¼‰",
    Fresh:  "Fresh / çˆ½ã‚„ã‹ï¼ˆè»½ã„ãƒ»æ¸…æ½”æ„Ÿï¼‰",
    Trust:  "Trust / ä¿¡é ¼ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ»å …å®Ÿï¼‰",
    Warm:   "Warm / ã‚ãŸãŸã‹ã„ï¼ˆè¦ªã—ã¿ãƒ»å®‰å¿ƒï¼‰",
    Pop:    "Pop / å…ƒæ°—ï¼ˆæ˜ã‚‹ã„ãƒ»å¼·ã„ï¼‰",
    Retro:  "Retro / ãƒ¬ãƒˆãƒ­ï¼ˆãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒ¼ãƒ»ä¸–ç•Œè¦³ï¼‰",
    Nature: "Nature / è‡ªç„¶ï¼ˆã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ãƒ»ç·‘ï¼‰",
    Night:  "Night / å¤œï¼ˆãƒ€ãƒ¼ã‚¯ãƒ»é›†ä¸­ï¼‰",
    Mono:   "Mono / ãƒ¢ãƒãƒˆãƒ¼ãƒ³ï¼ˆæœ€å°æ§‹æˆãƒ»æ±ç”¨ï¼‰",
    Pastel: "Pastel / ãƒ‘ã‚¹ãƒ†ãƒ«ï¼ˆå¯æ„›ã„ãƒ»æŸ”å’Œï¼‰",
  };
  const CATEGORY_ORDER = ["Calm","Fresh","Trust","Warm","Pop","Retro","Nature","Night","Mono","Pastel"];

  function applyThemeById(themeId) {
    const theme = THEMES.find(t => t.id === themeId);
    if (!theme) return;
    const root = document.documentElement;
    Object.entries(theme.vars).forEach(([k, v]) => root.style.setProperty(k, v));
    try { localStorage.setItem("pomo_theme_id", themeId); } catch(e) {}
  }

  // =========================
  // Messages
  // =========================
  const messageBox = $("messageBox");
  const MESSAGES = [
    "ä¼‘æ†©ã¯ã€Œå›å¾©ã€ãªã®ã§ã€ã‚µãƒœã‚Šã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚€ã—ã‚æ€§èƒ½ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã™ã€‚",
    "ã†ã¾ãå›ã‚‰ãªã„æ—¥ã§ã‚‚ã€é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ãŸæ™‚ç‚¹ã§ã¡ã‚ƒã‚“ã¨å‰ã«é€²ã‚“ã§ã¾ã™ã€‚",
    "é›†ä¸­ã¯æ°—åˆã§ã¯ãªãè¨­è¨ˆã§ã™ã€‚æ¬¡ã®æ™‚é–“ã¯â€œå®Ÿé¨“â€ã«ã—ã¾ã—ã‚‡ã†ã€‚",
    "å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„ã€‚å°‘ã—ã ã‘å‰ã¸ã€‚å°ã•ãç©ã‚€ã»ã©å¼·ã„ã€‚",
    "æ­¢ã¾ã£ã¦ã‚‚æˆ»ã‚ŒãŸã‚‰OKã€‚ä¸­æ–­ã¯å¤±æ•—ã˜ã‚ƒãªãã€èª¿æ•´ã§ã™ã€‚",
    "ä¼‘æ†©ã§å›å¾©ã—ãŸã¶ã‚“ã€æ¬¡ã®ä½œæ¥­ã¯è»½ããªã‚Šã¾ã™ã€‚",
    "ä»Šæ—¥ã¯ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚ˆã‚Šç¶™ç¶šã€‚é™ã‹ã«ç©ã¿ä¸Šã’ã‚‹æ—¥ã§ã„ãã¾ã—ã‚‡ã†ã€‚",
  ];
  function setRandomMessage() {
    if (!messageBox) return;
    const i = Math.floor(Math.random() * MESSAGES.length);
    messageBox.textContent = MESSAGES[i];
  }

  // =========================
  // Mode (Tabs)
  // =========================
  const settingsCard = $("settingsCard");
  const tabSimple = $("tabSimple");
  const tabDual = $("tabDual");

  const Mode = { SIMPLE:"simple", DUAL:"dual" };
  const Phase = { WORK:"work", WORKA:"workA", WORKB:"workB", BREAK:"break", LONG_BREAK:"long_break" };

  let settings = {
    mode: Mode.SIMPLE,
    workMin: 25,
    workAMin: 25,
    workBMin: 25,
    breakMin: 5,
    sets: 4,
    longEvery: 4,
    longMin: 15,
    autoNext: true,
    presetLabel: "25/5",
  };

  // çµ¶å¯¾æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã€Œè¦‹ãŸç›®ã ã‘æ­¢ã¾ã‚‹ã€ã‚’æ¸›ã‚‰ã™ï¼‰
  let timer = {
    running: false,
    phase: Phase.WORK,
    setIndex: 1,
    remainingSec: 25*60,
    phaseTotalSec: 25*60,
    intervalId: null,
    endAtMs: null,
  };

  function isBreakPhase() {
    return timer.phase === Phase.BREAK || timer.phase === Phase.LONG_BREAK;
  }
  function isLongBreakDue(){
    if (settings.longEvery <= 0) return false;
    return (timer.setIndex % settings.longEvery) === 0;
  }
  function initialPhaseForMode(){
    return (settings.mode === Mode.DUAL) ? Phase.WORKA : Phase.WORK;
  }

  function phaseSeconds(phase){
    if (phase === Phase.WORK) return settings.workMin * 60;
    if (phase === Phase.WORKA) return settings.workAMin * 60;
    if (phase === Phase.WORKB) return settings.workBMin * 60;
    if (phase === Phase.BREAK) return settings.breakMin * 60;
    return settings.longMin * 60;
  }
  function phaseLabel(){
    if (timer.phase === Phase.WORK) return "ä½œæ¥­";
    if (timer.phase === Phase.WORKA) return "ä½œæ¥­A";
    if (timer.phase === Phase.WORKB) return "ä½œæ¥­B";
    if (timer.phase === Phase.BREAK) return "ä¼‘æ†©";
    return "é•·ä¼‘æ†©";
  }

  function saveMode(){
    try{ localStorage.setItem("pomo_mode", settings.mode); }catch(e){}
  }
  function loadMode(){
    try{
      const m = localStorage.getItem("pomo_mode");
      if (m === Mode.SIMPLE || m === Mode.DUAL) settings.mode = m;
    }catch(e){}
  }
  function updateModeUI(){
    const isDual = settings.mode === Mode.DUAL;
    settingsCard.classList.toggle("dualMode", isDual);
    tabSimple.classList.toggle("active", !isDual);
    tabDual.classList.toggle("active", isDual);
  }

  // =========================
  // UI refs
  // =========================
  const ui = {
    themeSelect: $("themeSelect"),

    preset: $("preset"),
    sets: $("sets"),
    workMin: $("workMin"),
    workAMin: $("workAMin"),
    workBMin: $("workBMin"),
    breakMin: $("breakMin"),
    longEvery: $("longEvery"),
    longMin: $("longMin"),
    autoNext: $("autoNext"),
    btnApply: $("btnApply"),

    btnStart: $("btnStart"),
    btnPause: $("btnPause"),
    btnReset: $("btnReset"),
    btnSkip: $("btnSkip"),

    presetLabel: $("presetLabel"),
    phaseDot: $("phaseDot"),
    phaseText: $("phaseText"),
    timeText: $("timeText"),
    bar: $("bar"),
    setCount: $("setCount"),
    setTotal: $("setTotal"),

    rippleWrap: $("rippleWrap"),
    rippleText: $("rippleText"),
  };

  // =========================
  // Theme UI init
  // =========================
  function renderThemeSelect(){
    ui.themeSelect.innerHTML = "";

    const byCat = new Map();
    THEMES.forEach(t => {
      if (!byCat.has(t.category)) byCat.set(t.category, []);
      byCat.get(t.category).push(t);
    });

    CATEGORY_ORDER.forEach(cat => {
      const list = byCat.get(cat);
      if (!list || list.length === 0) return;

      const og = document.createElement("optgroup");
      og.label = CATEGORY_LABEL[cat] || cat;

      list.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.label;
        og.appendChild(opt);
      });

      ui.themeSelect.appendChild(og);
    });

    // ä¿é™ºï¼šæœªå®šç¾©ã‚«ãƒ†ã‚´ãƒª
    byCat.forEach((list, cat) => {
      if (CATEGORY_ORDER.includes(cat)) return;
      const og = document.createElement("optgroup");
      og.label = CATEGORY_LABEL[cat] || cat;
      list.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.label;
        og.appendChild(opt);
      });
      ui.themeSelect.appendChild(og);
    });
  }

  function loadThemeFromStorage(){
    let id = "calm_mist";
    try{ id = localStorage.getItem("pomo_theme_id") || id; }catch(e){}

    if (!THEMES.some(t => t.id === id)) id = THEMES[0]?.id || "calm_mist";

    renderThemeSelect();
    ui.themeSelect.value = id;
    applyThemeById(id);
  }

  ui.themeSelect.addEventListener("change", () => {
    applyThemeById(ui.themeSelect.value);
  });

  // =========================
  // Settings UI
  // =========================
  function applySettingsToInputs(){
    ui.sets.value = settings.sets;
    if (ui.workMin) ui.workMin.value = settings.workMin;
    if (ui.workAMin) ui.workAMin.value = settings.workAMin;
    if (ui.workBMin) ui.workBMin.value = settings.workBMin;
    ui.breakMin.value = settings.breakMin;
    ui.longEvery.value = settings.longEvery;
    ui.longMin.value = settings.longMin;
    ui.autoNext.checked = settings.autoNext;

    ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
    ui.setTotal.textContent = String(settings.sets);
  }

  // =========================
  // SE (WebAudio)
  // =========================
  const seEnabled = $("seEnabled");
  const seSelect = $("seSelect");
  const btnSeTest = $("btnSeTest");

  let audioCtx = null;
  function ensureAudioCtx(){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!audioCtx) audioCtx = new Ctx();
    if (audioCtx.state !== "running") audioCtx.resume().catch(() => {});
  }
  function sleep(ms){
    // èƒŒæ™¯ä¸­ã¯ setTimeout ãŒæ­¢ã¾ã‚‹/æ¿€ã—ãé…å»¶ã™ã‚‹ã®ã§ã€å¾…ãŸãšã«å³è§£æ±º
    if (document.hidden) return Promise.resolve();
    return new Promise(r => setTimeout(r, ms));
  }
  function playTone({ freq=880, duration=0.12, type="sine", gain=0.08 } = {}){
    try{
      ensureAudioCtx();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();

      o.type = type;
      o.frequency.value = freq;

      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

      o.connect(g);
      g.connect(ctx.destination);

      o.start(now);
      o.stop(now + duration + 0.02);
    }catch(e){}
  }

  function playStrongSwitchSE(breakNow){
    // ã€Œæ°—ã¥ãã€ç”¨ã®çŸ­ã„å¼·ã‚ãƒˆãƒ¼ãƒ³ï¼ˆ1å›ï¼‰
    // æ—¢å­˜SEã®é‚ªé­”ã‚’ã—ãªã„ã‚ˆã†çŸ­ããƒ»é«˜ã‚
    playTone({
      freq: breakNow ? 740 : 1040,
      duration: 0.18,
      type: "square",
      gain: 0.14
    });
  }
  
  async function playSwitchSE(){
    if (!seEnabled?.checked) return;
    const mode = seSelect?.value || "";
    if (!mode) return;
    const breakNow = isBreakPhase();
  
    if (mode === "beep"){
      playTone({ freq: breakNow ? 660 : 880, duration: 0.10, type:"sine", gain:0.07 });
      // â˜…è¿½åŠ ã§å¼·ã„SEã‚’é‡ã­ã‚‹
      playStrongSwitchSE(breakNow);
      return;
    }
    if (mode === "double"){
      playTone({ freq: breakNow ? 660 : 880, duration: 0.09, type:"sine", gain:0.07 });
      await sleep(120);
      playTone({ freq: breakNow ? 660 : 880, duration: 0.09, type:"sine", gain:0.07 });
      // â˜…è¿½åŠ ã§å¼·ã„SEã‚’é‡ã­ã‚‹
      playStrongSwitchSE(breakNow);
      return;
    }
    if (mode === "ding"){
      playTone({ freq: breakNow ? 523 : 784, duration: 0.14, type:"triangle", gain:0.06 });
      await sleep(40);
      playTone({ freq: breakNow ? 659 : 988, duration: 0.08, type:"sine", gain:0.04 });
      // â˜…è¿½åŠ ã§å¼·ã„SEã‚’é‡ã­ã‚‹
      playStrongSwitchSE(breakNow);
      return;
    }
    if (mode === "alarm"){
      for (let i=0;i<3;i++){
        playTone({ freq: 990, duration: 0.08, type:"square", gain:0.05 });
        await sleep(110);
      }
      // â˜…è¿½åŠ ã§å¼·ã„SEã‚’é‡ã­ã‚‹
      playStrongSwitchSE(breakNow);
      return;
    }
  }
  
  btnSeTest.addEventListener("click", async () => {
    ensureAudioCtx();
    await playSwitchSE();
  });

  // =========================
  // BGM
  // =========================
  const bgm = $("bgm");
  const bgmSelect = $("bgmSelect");

  function saveBgmSelection(){
    try{
      localStorage.setItem("pomo_bgm_file", bgmSelect?.value || "");
    }catch(e){}
  }
  
  function loadBgmSelection(){
    try{
      return localStorage.getItem("pomo_bgm_file") || "";
    }catch(e){
      return "";
    }
  }

  // ===== BGMãƒªã‚¹ãƒˆï¼ˆaudio/bgm-list.jsonï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§ select ã‚’æ§‹ç¯‰ =====
  async function loadBgmList(){
    if (!bgmSelect) return;
  
    try{
      const res = await fetch("audio/bgm-list.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
  
      const data = await res.json();
  
      // ç”Ÿæˆæ–¹å¼ã®æºã‚Œã‚’å¸åï¼š ["a.mp3"] ã§ã‚‚ { files:["a.mp3"] } ã§ã‚‚OK
      const list = Array.isArray(data) ? data : (Array.isArray(data?.files) ? data.files : []);
  
      const saved = loadBgmSelection();
  
      // ã„ã£ãŸã‚“ä½œã‚Šç›´ã—
      bgmSelect.innerHTML = "";
  
      const none = document.createElement("option");
      none.value = "";
      none.textContent = "ãªã—";
      bgmSelect.appendChild(none);
  
      for (const name of list){
        if (typeof name !== "string") continue;
        const trimmed = name.trim();
        if (!trimmed) continue;
  
        const opt = document.createElement("option");
        opt.value = trimmed;
        opt.textContent = trimmed;
        bgmSelect.appendChild(opt);
      }
  
      // ä¿å­˜å€¤ãŒæœ‰åŠ¹ãªã‚‰å¾©å…ƒ
      if (saved && list.includes(saved)){
        bgmSelect.value = saved;
      }else{
        bgmSelect.value = "";
      }
  
    }catch(e){
      // ç”»é¢ã«ä½™è¨ˆãªæ–‡å­—ã¯å‡ºã•ãªã„ï¼ˆè¦æœ›é€šã‚Šï¼‰
      // ãŸã ã—åŸå› èª¿æŸ»ã§ãã‚‹ã‚ˆã†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯æ®‹ã™
      console.warn("[BGM] bgm-list.json load failed:", e);
    }
  }
  
  const bgmError = $("bgmError");
  const bgmWorkOn = $("bgmWorkOn");
  const bgmBreakOn = $("bgmBreakOn");
  const btnBgmPlay = $("btnBgmPlay");
  const btnBgmStop = $("btnBgmStop");

  // æ“ä½œãƒãƒ¼
  const btnBgmToggle = $("btnBgmToggle");
  const bgmSeek = $("bgmSeek");
  const bgmVol = $("bgmVol");
  const bgmCur = $("bgmCur");
  const bgmDur = $("bgmDur");

  function showBgmError(msg) {
    if (!bgmError) return;
    bgmError.textContent = msg;
    bgmError.classList.add("show");
  }
  function clearBgmError() {
    if (!bgmError) return;
    bgmError.textContent = "";
    bgmError.classList.remove("show");
  }

  function buildAudioUrl(fileName) {
    return "audio/" + encodeURIComponent(fileName);
  }

  let audioUnlocked = false;
  async function unlockAudioOnce(){
    if (audioUnlocked) return;
    try{
      if (!bgm) return;
      bgm.muted = true;
      const p = bgm.play();
      if (p && typeof p.then === "function") await p;
      bgm.pause();
      bgm.currentTime = 0;
      bgm.muted = false;
      audioUnlocked = true;
    }catch(e){
      if (bgm) bgm.muted = false;
      audioUnlocked = false;
    }
  }

  async function setBgmSrc(fileName) {
    if (!bgm) return;

    bgm.pause();
    bgm.currentTime = 0;

    if (!fileName) {
      bgm.removeAttribute("src");
      bgm.load();
      clearBgmError();
      updateBgmBarUI();
      return;
    }

    const url = buildAudioUrl(fileName);
    clearBgmError();
    bgm.src = url;
    bgm.load();
  }

  async function playBgmNow(){
    if (!bgm || !bgmSelect || !bgmSelect.value) return;
    try{
      await bgm.play();
      clearBgmError();
    }catch(e){
      showBgmError(
        "BGMã‚’å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n" +
        "ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ã«ã‚ˆã‚Šã€æœ€åˆã¯ã€Œé–‹å§‹ã€ãªã©ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™ã€‚"
      );
    } finally {
      updateBgmBarUI();
    }
  }

  function stopBgmNow(){
    if (!bgm) return;
    try{
      bgm.pause();
      // iOS/Safariã®é³´ã‚Šæ®‹ã‚Šå¯¾ç­–ï¼ˆå¿µã®ãŸã‚ï¼‰
      bgm.muted = true;
      bgm.currentTime = 0;
      bgm.muted = false;
    }catch(e){}
    updateBgmBarUI();
  }

  async function syncBgmForPhase(){
    if (!bgm || !bgmSelect) return;
  
    // BGMæœªé¸æŠãªã‚‰ç¢ºå®Ÿã«åœæ­¢
    if (!bgmSelect.value){
      stopBgmNow();
      return;
    }
  
    const inBreak = isBreakPhase();
    const shouldPlay = inBreak ? !!bgmBreakOn?.checked : !!bgmWorkOn?.checked;
  
    // â˜…OFFã®ã¨ãã¯ã€Œéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚‚ã€å¿…ãšæ­¢ã‚ã‚‹ï¼ˆã“ã“ãŒé‡è¦ï¼‰
    if (!shouldPlay){
      stopBgmNow();
      return;
    }
  
    // â˜…ONã ã‘ã©ã‚¿ãƒ–éè¡¨ç¤ºä¸­ã¯ã€Œå†ç”Ÿã¯è©¦ã•ãªã„ã€ï¼ˆæ­¢ã‚ãªã„ï¼é³´ã‚‰ã•ãªã„ï¼‰
    // å¾©å¸°æ™‚ã« handleResume() å´ã§ sync ãŒèµ°ã‚‹ã®ã§ãã“ã§é³´ã‚‹
    if (document.hidden) return;
  
    const nextUrl = buildAudioUrl(bgmSelect.value);
    const nextAbs = new URL(nextUrl, location.href).href;
    const curAbs = bgm.currentSrc || bgm.src || "";
    if (curAbs !== nextAbs) await setBgmSrc(bgmSelect.value);
  
    await playBgmNow();
  }

  function updateBgmBarUI(){
    if (!bgm || !btnBgmToggle || !bgmCur || !bgmDur || !bgmSeek || !bgmVol) return;

    // volume
    const v = Number(bgmVol.value);
    if (!Number.isNaN(v)) bgm.volume = Math.max(0, Math.min(1, v));

    // duration
    const dur = Number.isFinite(bgm.duration) ? bgm.duration : 0;
    const cur = Number.isFinite(bgm.currentTime) ? bgm.currentTime : 0;

    bgmCur.textContent = fmtMSS(cur);
    bgmDur.textContent = fmtMSS(dur);

    // seek (0..1000)
    const ratio = dur > 0 ? (cur / dur) : 0;
    const pos = Math.round(Math.max(0, Math.min(1, ratio)) * 1000);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ã«ä¸Šæ›¸ãã—ãªã„ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¬ã‚¿ã¤ãé˜²æ­¢ï¼‰
    if (!bgmSeek.matches(":active")) bgmSeek.value = String(pos);

    btnBgmToggle.textContent = bgm.paused ? "â–¶" : "âšâš";
  }

  if (bgm) {
    // åˆæœŸéŸ³é‡åæ˜ 
    if (bgmVol) bgm.volume = Number(bgmVol.value) || 0.2;

    bgm.addEventListener("error", () => {
      const code = bgm.error?.code;
      showBgmError(
        "BGMã®èª­ã¿è¾¼ã¿/å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" +
        `url: ${bgm.currentSrc || bgm.src}\n` +
        `errorCode: ${code || "unknown"}\n` +
        "audio/ãƒ•ã‚©ãƒ«ãƒ€ã®é…ç½®ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€é…ä¿¡ç’°å¢ƒï¼ˆfile://ç›´é–‹ãç­‰ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
      );
      updateBgmBarUI();
    });

    bgm.addEventListener("loadedmetadata", updateBgmBarUI);
    bgm.addEventListener("timeupdate", updateBgmBarUI);
    bgm.addEventListener("play", updateBgmBarUI);
    bgm.addEventListener("pause", updateBgmBarUI);
    bgm.addEventListener("ended", updateBgmBarUI);
  }

  if (bgmSelect) {
    bgmSelect.addEventListener("change", async () => {
      saveBgmSelection();
  
      await unlockAudioOnce();
      await setBgmSrc(bgmSelect.value);
      await syncBgmForPhase();
      updateBgmBarUI();
    });
  }
  
  bgmWorkOn?.addEventListener("change", () => syncBgmForPhase());
  bgmBreakOn?.addEventListener("change", () => syncBgmForPhase());

  btnBgmPlay?.addEventListener("click", async () => {
    await unlockAudioOnce();
    if (bgmSelect.value) await setBgmSrc(bgmSelect.value);
    await playBgmNow();
  });
  btnBgmStop?.addEventListener("click", () => {
    stopBgmNow();
    clearBgmError();
  });

  btnBgmToggle?.addEventListener("click", async () => {
    await unlockAudioOnce();
    if (!bgm) return;

    if (!bgmSelect?.value) {
      showBgmError("BGMã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    // æœªè¨­å®šãªã‚‰ã‚»ãƒƒãƒˆ
    const nextUrl = buildAudioUrl(bgmSelect.value);
    const nextAbs = new URL(nextUrl, location.href).href;
    const curAbs = bgm.currentSrc || bgm.src || "";
    if (curAbs !== nextAbs) await setBgmSrc(bgmSelect.value);

    if (bgm.paused) await playBgmNow();
    else bgm.pause();

    updateBgmBarUI();
  });

  bgmVol?.addEventListener("input", () => updateBgmBarUI());

  bgmSeek?.addEventListener("input", () => {
    if (!bgm) return;
    const dur = Number.isFinite(bgm.duration) ? bgm.duration : 0;
    if (dur <= 0) return;
    const v = Number(bgmSeek.value);
    const ratio = Math.max(0, Math.min(1000, v)) / 1000;
    bgm.currentTime = ratio * dur;
    updateBgmBarUI();
  });

  // =========================
  // Timer UI update
  // =========================
  function updateRippleUI(){
    ui.rippleWrap.classList.toggle("rippleOn", isBreakPhase());
    ui.rippleWrap.setAttribute("aria-hidden", isBreakPhase() ? "false" : "true");

    if (timer.phase === Phase.BREAK) {
      ui.rippleText.textContent = "ä¼‘æ†©ä¸­ï¼šè‚©ã‚’è½ã¨ã—ã¦ã€å‘¼å¸ã‚’ã²ã¨ã¤ã€‚";
    } else if (timer.phase === Phase.LONG_BREAK) {
      ui.rippleText.textContent = "é•·ä¼‘æ†©ï¼šæ°´åˆ†è£œçµ¦ã€‚ç›®ã‚’é ãã«ã€‚";
    } else {
      ui.rippleText.textContent = "";
    }
  }

  function updatePhaseUI(){
    const breakMode = isBreakPhase();
    ui.phaseDot.classList.toggle("break", breakMode);
    ui.bar.classList.toggle("break", breakMode);

    ui.phaseText.textContent = phaseLabel();
    ui.setCount.textContent = String(timer.setIndex);
    ui.timeText.textContent = fmtMMSS(timer.remainingSec);

    const pct = timer.phaseTotalSec > 0
      ? ((timer.phaseTotalSec - timer.remainingSec) / timer.phaseTotalSec) * 100
      : 0;
    ui.bar.style.width = `${Math.min(100, Math.max(0, pct))}%`;

    document.title = `${ui.phaseText.textContent} ${fmtMMSS(timer.remainingSec)} - ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­`;
    updateRippleUI();
  }

  function setButtons(){
    ui.btnStart.disabled = timer.running;
    ui.btnPause.disabled = !timer.running;
  }

  function stopInterval(){
    if (timer.intervalId){
      clearInterval(timer.intervalId);
      timer.intervalId = null;
    }
    timer.running = false;
    timer.endAtMs = null;
    setButtons();
  }

  function computeRemainingFromEndAt(){
    if (!timer.endAtMs) return timer.remainingSec;
    const now = Date.now();
    const diff = timer.endAtMs - now;
    return Math.max(0, Math.ceil(diff / 1000));
  }

  async function tick(){
    // çµ¶å¯¾æ™‚åˆ»ã‹ã‚‰æ®‹ã‚Šã‚’å†è¨ˆç®—
    timer.remainingSec = computeRemainingFromEndAt();

    if (timer.remainingSec <= 0){
      timer.remainingSec = 0;
      updatePhaseUI();
      await onPhaseComplete();
      return;
    }
    updatePhaseUI();
  }

  function startInterval(){
    if (timer.running) return;
    timer.running = true;
    // ç¾åœ¨ã®remainingã‹ã‚‰çµ¶å¯¾çµ‚äº†æ™‚åˆ»ã‚’ç¢ºå®š
    timer.endAtMs = Date.now() + (timer.remainingSec * 1000);

    setButtons();
    // 250msã§UIè¿½å¾“ï¼ˆå®Ÿæ™‚é–“è£œæ­£ã‚’å„ªå…ˆï¼‰
    timer.intervalId = setInterval(() => { tick(); }, 250);
    tick();
  }

  function resetToPhase(phase){
    timer.phase = phase;
    timer.phaseTotalSec = phaseSeconds(phase);
    timer.remainingSec = phaseSeconds(phase);
    timer.endAtMs = timer.running ? (Date.now() + timer.remainingSec * 1000) : null;
  
    updatePhaseUI();
  
    // â˜…è¿½åŠ ï¼šãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ç›´å¾Œã«å¿…ãšBGMåŒæœŸï¼ˆä¼‘æ†©BGM OFFãªã‚‰ã“ã“ã§æ­¢ã¾ã‚‹ï¼‰
    syncBgmForPhase();   // awaitä¸è¦ï¼ˆæ­¢ã‚ã‚‹/å†ç”Ÿã®åˆ¤å®šã‚’å³åæ˜ ï¼‰
    updateBgmBarUI();    // è¡¨ç¤ºè¿½å¾“
  }

  function resetAll(){
    stopInterval();
    timer.setIndex = 1;
    resetToPhase(initialPhaseForMode());
  }

  async function onPhaseComplete(){
    // ã“ã“ã«å…¥ã‚‹æ™‚ç‚¹ã§ interval ã¯å›ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§åœæ­¢
    stopInterval();
    setRandomMessage();
  
    // ===== æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºè¨ˆç®—ï¼ˆã“ã“ã¯å¿…ãšå…ˆã«é€²ã‚ã‚‹ï¼‰=====
    if (settings.mode === Mode.SIMPLE){
      if (timer.phase === Phase.WORK){
        resetToPhase(isLongBreakDue() ? Phase.LONG_BREAK : Phase.BREAK);
      } else {
        timer.setIndex = (timer.setIndex < settings.sets) ? (timer.setIndex + 1) : 1;
        resetToPhase(Phase.WORK);
      }
    } else {
      if (timer.phase === Phase.WORKA){
        resetToPhase(Phase.WORKB);
      } else if (timer.phase === Phase.WORKB){
        resetToPhase(isLongBreakDue() ? Phase.LONG_BREAK : Phase.BREAK);
      } else {
        timer.setIndex = (timer.setIndex < settings.sets) ? (timer.setIndex + 1) : 1;
        resetToPhase(Phase.WORKA);
      }
    }
  
    // â˜…BGMã¯ã€ŒOFFãªã‚‰æ­¢ã‚ã‚‹ã€ã‚’æœ€å„ªå…ˆã§å¸¸ã«åæ˜ 
    // ã€€ONã®å ´åˆã®ã¿ã€ã‚¿ãƒ–éè¡¨ç¤ºä¸­ã¯å†ç”Ÿã‚’è©¦ã•ãªã„ï¼ˆsyncå´ã§æŠ‘æ­¢æ¸ˆã¿ï¼‰
    syncBgmForPhase();
    
    // â˜…åˆ‡æ›¿SEã¯ã€ã‚¿ãƒ–éè¡¨ç¤ºä¸­ã¯é³´ã‚‰ãã†ã¨ã—ãªã„ï¼ˆç„¡ç†ã«ã‚„ã‚‰ãªã„ï¼‰
    if (!document.hidden){
      ensureAudioCtx();
      playSwitchSE(); // awaitã—ãªã„
    }
  
    // ===== è‡ªå‹•ã§æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ =====
    if (settings.autoNext) startInterval();
  }

  function skipPhase(){
    timer.remainingSec = 0;
    updatePhaseUI();
    onPhaseComplete();
  }

  // =========================
  // Presets
  // =========================
  function parsePresetValue(v){
    const [w,b,s,l] = v.split("_").map(x => parseInt(x, 10));
    return { workMin:w, breakMin:b, sets:s, longEvery:s, longMin:l };
  }

  function applyPreset(value){
    if (value === "custom"){
      settings.presetLabel = "Custom";
      ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
      return;
    }
    const p = parsePresetValue(value);

    settings.workMin = p.workMin;
    settings.workAMin = p.workMin;
    settings.workBMin = p.workMin;

    settings.breakMin = p.breakMin;
    settings.sets = p.sets;
    settings.longEvery = p.longEvery;
    settings.longMin = p.longMin;
    settings.presetLabel = `${p.workMin}/${p.breakMin}`;

    applySettingsToInputs();
    if (!timer.running) resetAll();
  }

  function readSettingsFromInputs(){
    const sets = Math.max(1, Math.min(12, parseInt(ui.sets.value,10) || 4));
    const breakMin = Math.max(1, Math.min(60, parseInt(ui.breakMin.value,10) || 5));
    const longEvery = Math.max(0, Math.min(12, parseInt(ui.longEvery.value,10) || 0));
    const longMin = Math.max(1, Math.min(120, parseInt(ui.longMin.value,10) || 15));

    settings.sets = sets;
    settings.breakMin = breakMin;
    settings.longEvery = longEvery;
    settings.longMin = longMin;
    settings.autoNext = ui.autoNext.checked;

    if (settings.mode === Mode.SIMPLE){
      const workMin = Math.max(1, Math.min(180, parseInt(ui.workMin.value,10) || 25));
      settings.workMin = workMin;
      settings.presetLabel = `${settings.workMin}/${settings.breakMin}`;
    } else {
      const workAMin = Math.max(1, Math.min(180, parseInt(ui.workAMin.value,10) || 25));
      const workBMin = Math.max(1, Math.min(180, parseInt(ui.workBMin.value,10) || 25));
      settings.workAMin = workAMin;
      settings.workBMin = workBMin;
      settings.presetLabel = `A${settings.workAMin}/B${settings.workBMin}/ä¼‘${settings.breakMin}`;
    }
  }

  // =========================
  // Events
  // =========================
  ui.preset.addEventListener("change", () => applyPreset(ui.preset.value));

  ui.btnApply.addEventListener("click", async () => {
    readSettingsFromInputs();
    applySettingsToInputs();
    if (!timer.running) resetAll();
    await syncBgmForPhase();
  });

  ui.btnStart.addEventListener("click", async () => {
    ensureAudioCtx();
    await unlockAudioOnce();
    await syncBgmForPhase();
    startInterval();
  });

  ui.btnPause.addEventListener("click", () => {
    // pause: çµ¶å¯¾æ™‚åˆ»ã‹ã‚‰æ®‹ã‚Šã‚’ç¢ºå®šã—ã¦åœæ­¢
    if (timer.running){
      timer.remainingSec = computeRemainingFromEndAt();
      stopInterval();
      updatePhaseUI();
    }
  });

  ui.btnReset.addEventListener("click", () => resetAll());
  ui.btnSkip.addEventListener("click", () => skipPhase());

  function setMode(next){
    settings.mode = next;
    updateModeUI();
    saveMode();
    resetAll();
    syncBgmForPhase();
  }
  tabSimple.addEventListener("click", () => setMode(Mode.SIMPLE));
  tabDual.addEventListener("click", () => setMode(Mode.DUAL));


  function handleResume(){
  // runningä¸­ã§ãªã‘ã‚Œã°ã€è¡¨ç¤ºã ã‘è£œæ­£
  if (!timer.running){
    updatePhaseUI();
    return;
  }

  // æ®‹ã‚Šã‚’å†è¨ˆç®—
  timer.remainingSec = computeRemainingFromEndAt();
  updatePhaseUI();

  // 0ç§’ã‚’è·¨ã„ã§ã„ãŸã‚‰è‡ªå‹•ã§æ¬¡ã¸ï¼ˆã‚¿ãƒƒãƒ—ä¸è¦ï¼‰
  if (timer.remainingSec <= 0){
    onPhaseComplete(); // awaitä¸è¦ï¼ˆå†…éƒ¨ã§é€²è¡Œã‚’å„ªå…ˆã—ã¦ã„ã‚‹ï¼‰
  } else {
    // å¾©å¸°ã—ãŸã‚‰BGMåŒæœŸã ã‘ã¯ã—ã¦ãŠãï¼ˆå¾©å¸°å¾Œã¯å†ç”Ÿå¯èƒ½æ€§ãŒä¸ŠãŒã‚‹ï¼‰
    syncBgmForPhase();
  }
}
  
  // ã‚¿ãƒ–å¾©å¸°ãƒ»ç”»é¢å¾©å¸°æ™‚ã«è£œæ­£ï¼ˆã€Œæ­¢ã¾ã£ãŸã‚ˆã†ã«è¦‹ãˆã‚‹ã€ã‚’è»½æ¸›ï¼‰
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) handleResume();
  });
  
  window.addEventListener("focus", () => {
    handleResume();
  });

  // =========================
  // Init
  // =========================
  (function init(){
    loadMode();
    updateModeUI();
    loadThemeFromStorage();   // ãƒ†ãƒ¼ãƒselectã‚’æ§‹ç¯‰ï¼†åæ˜ 

    applySettingsToInputs();
    resetAll();
    setButtons();
    setRandomMessage();

    // BGMãƒãƒ¼åˆæœŸåŒ–ï¼ˆéŸ³é‡ãªã©ï¼‰
    updateBgmBarUI();

    // BGMãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ï¼ˆè‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸä¸€è¦§ã‚’ä½¿ã†ï¼‰
    loadBgmList().then(async () => {
      // åæ˜ å¾Œã€é¸æŠã•ã‚Œã¦ã„ã‚‹BGMã«åŒæœŸï¼ˆé¸æŠãªã—ãªã‚‰æ­¢ã¾ã‚‹ï¼‰
      if (bgmSelect?.value) await setBgmSrc(bgmSelect.value);
      await syncBgmForPhase();
      updateBgmBarUI();
    }).catch(() => {
      updateBgmBarUI();
    });
  })();
</script>
</body>
</html>
