<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ポモドーロタイマー</title>
<style>
  :root{
    /* テーマ（Twilight固定） */
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text:#ffffff;
    --muted: rgba(255,255,255,.88);

    --accent:#38bdf8;      /* 作業 */
    --break:#22c55e;       /* 休憩 */
    --start1:#22c55e;
    --start2:#16a34a;
    --stop1:#6b7280;
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);
    --radius: 18px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 18px;
  }

  .wrap{
    width: min(980px, 100%);
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap: 16px;
  }
  @media (max-width: 860px){
    .wrap{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--card);
    border: 1px solid rgba(255,255,255,.18);
    border-radius: var(--radius);
    box-shadow: 0 14px 40px var(--shadow);
    padding: 18px;
    backdrop-filter: blur(8px);
  }

  .header{
    display:flex;
    justify-content:space-between;
    gap: 12px;
    align-items:flex-start;
    margin-bottom: 10px;
  }

  h1{ margin:0; font-size: 18px; letter-spacing:.02em; }
  .sub{ margin-top:6px; color: var(--muted); font-size: 13px; line-height: 1.5; }

  .pill{
    background: rgba(255,255,255,.16);
    border: 1px solid rgba(255,255,255,.18);
    padding: 8px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* タイマー表示 */
  .phaseRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top: 10px; }
  .phaseTag{
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 10px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: var(--muted);
    font-size: 12px;
  }
  .dot{ width:10px; height:10px; border-radius:999px; background: var(--accent); box-shadow: 0 0 12px rgba(56,189,248,.7); }
  .dot.break{ background: var(--break); box-shadow: 0 0 12px rgba(34,197,94,.65); }

  .bigTime{
    font-variant-numeric: tabular-nums;
    font-size: 64px;
    text-align:center;
    margin: 12px 0 10px;
    letter-spacing: .02em;
  }

  .progress{
    width:100%;
    height: 14px;
    background: rgba(255,255,255,.16);
    border-radius: 999px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.18);
  }
  .bar{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(14,165,233,.85));
    border-radius: 999px;
    transition: width .25s linear;
  }
  .bar.break{
    background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(22,163,74,.85));
  }

  .controls{
    display:flex; flex-wrap:wrap; gap: 10px;
    justify-content:center; margin-top: 12px;
  }

  button{
    border:0;
    padding: 12px 14px;
    border-radius: 12px;
    cursor:pointer;
    color: var(--text);
    font-weight: 650;
    letter-spacing:.02em;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.18);
  }
  .primary{
    background: linear-gradient(135deg, var(--start1), var(--start2));
  }
  .secondary{
    background: linear-gradient(135deg, var(--stop1), var(--stop2));
  }
  .warn{
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  /* 右側（コンパクト） */
  .compact{ padding: 14px; }
  .compact label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
  .compact select{
    width:100%;
    padding: 10px 10px;
    border-radius: 10px;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.18);
    color: var(--text);
    outline:none;
  }
  .compact button{ padding: 10px 12px; border-radius: 10px; }
  .compact .hint{ color: var(--muted); font-size: 12px; line-height: 1.5; margin-top: 6px; }

  .switch{
    display:flex; align-items:center; gap: 10px;
    padding: 10px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.16);
  }
  .switch input{ transform: scale(1.15); }

  details.panel{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.08);
    border-radius: 12px;
    padding: 10px 10px;
  }
  details.panel > summary{
    cursor: pointer;
    list-style: none;
    font-weight: 650;
    color: rgba(255,255,255,.92);
    outline: none;
  }
  details.panel > summary::-webkit-details-marker{ display:none; }
  details.panel .inner{ margin-top: 10px; display:grid; gap: 10px; }

  .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
  .row.right{ justify-content:flex-end; }

  .bgmRowInline{
    display:flex;
    align-items:center;
    gap: 12px;
    margin-top: 6px;
  }
  .bgmBtns{
    display:flex;
    gap: 10px;
    flex-shrink: 0;
  }
  .bgmNoteInline{
    font-size: 12px;
    line-height: 1.5;
    color: var(--muted);
    white-space: normal;
  }
  @media (max-width: 860px){
    .bgmRowInline{ flex-direction: column; align-items: flex-start; }
  }

  /* 休憩中だけ波紋アニメーション */
  .rippleWrap{
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-top: 6px;
    height: 140px;
  }
  .ripple{
    position:absolute;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    opacity: 0;
    border: 2px solid rgba(34,197,94,.65);
    box-shadow: 0 0 18px rgba(34,197,94,.25);
  }
  .rippleOn .ripple{
    opacity: 1;
    animation: ripple 2.6s ease-out infinite;
  }
  .rippleOn .ripple.r2{ animation-delay: .8s; }
  .rippleOn .ripple.r3{ animation-delay: 1.6s; }

  @keyframes ripple{
    0%   { transform: scale(1);   opacity: .0; }
    15%  { opacity: .65; }
    100% { transform: scale(14); opacity: 0; }
  }

  .rippleText{
    z-index: 2;
    color: rgba(255,255,255,.92);
    font-size: 13px;
    text-align:center;
    line-height: 1.5;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.14);
  }

  /* 左下メッセージ：カード */
  .messageCard{
    margin-top: 14px;
    padding: 14px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.20);
    box-shadow: 0 10px 24px rgba(0,0,0,.12);
    font-size: 15px;
    line-height: 1.8;
    color: rgba(255,255,255,.95);
  }
  @media (max-width: 860px){
    .messageCard{ font-size: 16px; }
  }

  /* エラー */
  .error{
    margin-top: 6px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: rgba(255,255,255,.92);
    font-size: 12px;
    line-height: 1.55;
    display:none;
  }
  .error.show{ display:block; }
</style>
</head>

<body>
  <div class="wrap">
    <!-- Left: Timer -->
    <section class="card compact">
      <div class="header">
        <div>
          <h1>ポモドーロタイマー</h1>
        </div>
        <div class="pill" id="presetLabel">Preset: 25/5</div>
      </div>

      <div class="phaseRow">
        <div class="phaseTag"><span class="dot" id="phaseDot"></span><span id="phaseText">作業</span></div>
        <div class="pill">セット: <span id="setCount">1</span> / <span id="setTotal">4</span></div>
      </div>

      <div class="bigTime" id="timeText">25:00</div>

      <div class="progress" aria-label="progress">
        <div class="bar" id="bar"></div>
      </div>

      <!-- 休憩中だけ波紋 -->
      <div class="rippleWrap" id="rippleWrap" aria-hidden="true">
        <div class="ripple r1"></div>
        <div class="ripple r2"></div>
        <div class="ripple r3"></div>
        <div class="rippleText" id="rippleText">休憩中：肩を落として、呼吸をひとつ。</div>
      </div>

      <div class="controls">
        <button class="primary" id="btnStart">開始</button>
        <button class="secondary" id="btnPause" disabled>一時停止</button>
        <button id="btnReset">リセット</button>
        <button class="warn" id="btnSkip">次へ</button>
      </div>

      <div class="messageCard" id="messageBox"></div>
    </section>

    <!-- Right: Settings (requested 4 items only) -->
    <section class="card compact">
      <div class="header">
        <div>
          <h1>設定 / BGM</h1>
          <div class="sub">自動切替・切替音・BGMのみ。プリセットは 25/5（4セット）固定です。</div>
        </div>
      </div>

      <!-- 1) 自動で次フェーズへ -->
      <div class="switch">
        <input id="autoNext" type="checkbox" checked />
        <div>
          <div style="font-weight:650;">自動で次フェーズへ</div>
          <div class="hint">ONだと、0秒で作業↔休憩を自動切替します。</div>
        </div>
      </div>

      <!-- 2) フェーズ切替サウンド -->
      <details class="panel" open>
        <summary>フェーズ切替サウンド</summary>
        <div class="inner">
          <div>
            <label for="seSelect">効果音（切替時に1回）</label>
            <select id="seSelect">
              <option value="">なし</option>
              <option value="beep">ピッ（短）</option>
              <option value="double">ピピ（2回）</option>
              <option value="ding">ポン（柔らか）</option>
              <option value="alarm">ピピピ（強め）</option>
            </select>
          </div>
          <div class="row">
            <button type="button" id="btnSeTest">音テスト</button>
            <div class="hint">※最初の音出しは、ボタン操作が必要です。</div>
          </div>
        </div>
      </details>

      <!-- 3) BGM -->
      <details class="panel" open>
        <summary>BGM</summary>
        <div class="inner">
          <div>
            <label for="bgmSelect">BGM（プルダウン）</label>
            <select id="bgmSelect">
              <option value="">なし</option>
              <option value="10degrees_Celsius_2.mp3">10℃_2.mp3</option>
              <option value="2_23_AM_2.mp3">2_23_AM_2.mp3</option>
              <option value="Chill_Sunset.mp3">Chill_Sunset.mp3</option>
              <option value="You_and_Me_2.mp3">You_and_Me_2.mp3</option>
              <option value="優しい灯火(Tenderly_glow).mp3">優しい灯火(Tenderly_glow).mp3</option>
              <option value="神隠しの真相_2.mp3">神隠しの真相_2.mp3</option>
              <option value="野良猫は宇宙を目指した_2.mp3">野良猫は宇宙を目指した_2.mp3</option>
            </select>
          </div>

          <div class="bgmRowInline">
            <div class="bgmBtns">
              <button type="button" id="btnBgmPlay">BGM 再生</button>
              <button type="button" id="btnBgmStop">BGM 停止</button>
            </div>
            <div class="bgmNoteInline">
              注意：ブラウザ仕様で、最初の音出しは「ボタン押下」などユーザー操作が必要です。
            </div>
          </div>

          <div class="row">
            <label style="margin:0;">
              <input type="checkbox" id="bgmWorkOn" checked />
              <span style="margin-left:6px;">作業中はBGMを鳴らす</span>
            </label>
            <label style="margin:0;">
              <input type="checkbox" id="bgmBreakOn" />
              <span style="margin-left:6px;">休憩中はBGMを鳴らす</span>
            </label>
          </div>

          <div class="error" id="bgmError"></div>
          <audio id="bgm" preload="none" loop></audio>
        </div>
      </details>

      <!-- 4) 設定を適用 -->
      <div class="row right" style="margin-top:10px;">
        <button id="btnApply" class="primary" type="button">設定を適用</button>
      </div>
    </section>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const pad2 = (n) => String(n).padStart(2, "0");
  const fmtMMSS = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${pad2(m)}:${pad2(s)}`;
  };

  // ---------------- Messages ----------------
  const messageBox = $("messageBox");
  const MESSAGES = [
    "休憩は「回復」なので、サボりではありません。むしろ性能チューニングです。",
    "うまく回らない日でも、開始ボタンを押せた時点でちゃんと前に進んでます。",
    "集中は気合ではなく設計です。次の25分は“実験”にしましょう。",
    "完璧じゃなくていい。25分だけ前へ。小さく積むほど強い。",
    "止まっても戻れたらOK。中断は失敗じゃなく、調整です。",
    "休憩で回復したぶん、次の作業は軽くなります。脳は単純で可愛い。",
    "今日はスピードより継続。静かに積み上げる日でいきましょう。",
  ];
  function setRandomMessage() {
    if (!messageBox) return;
    const i = Math.floor(Math.random() * MESSAGES.length);
    messageBox.textContent = MESSAGES[i];
  }

  // ---------------- Settings ----------------
  // ※右側UIを簡略化したので、時間系は固定（必要なら後で戻せます）
  const settings = {
    workMin: 25,
    breakMin: 5,
    sets: 4,
    longEvery: 4,
    longMin: 15,
    autoNext: true,
    presetLabel: "25/5",
  };

  // ---------------- Timer state ----------------
  const Phase = { WORK:"work", BREAK:"break", LONG_BREAK:"long_break" };

  const timer = {
    running: false,
    phase: Phase.WORK,
    setIndex: 1,
    remainingSec: settings.workMin * 60,
    phaseTotalSec: settings.workMin * 60,
    intervalId: null,
  };

  // ---------------- UI refs ----------------
  const ui = {
    autoNext: $("autoNext"),
    btnApply: $("btnApply"),

    btnStart: $("btnStart"),
    btnPause: $("btnPause"),
    btnReset: $("btnReset"),
    btnSkip: $("btnSkip"),

    presetLabel: $("presetLabel"),
    phaseDot: $("phaseDot"),
    phaseText: $("phaseText"),
    timeText: $("timeText"),
    bar: $("bar"),
    setCount: $("setCount"),
    setTotal: $("setTotal"),

    rippleWrap: $("rippleWrap"),
    rippleText: $("rippleText"),
  };

  // ---------------- Phase helpers ----------------
  function isBreakPhase() {
    return timer.phase === Phase.BREAK || timer.phase === Phase.LONG_BREAK;
  }
  function isLongBreakDue(){
    if (settings.longEvery <= 0) return false;
    return (timer.setIndex % settings.longEvery) === 0;
  }

  // ---------------- Ripple UI ----------------
  function updateRippleUI(){
    ui.rippleWrap.classList.toggle("rippleOn", isBreakPhase());
    ui.rippleWrap.setAttribute("aria-hidden", isBreakPhase() ? "false" : "true");

    if (timer.phase === Phase.BREAK) {
      ui.rippleText.textContent = "休憩中：肩を落として、呼吸をひとつ。";
    } else if (timer.phase === Phase.LONG_BREAK) {
      ui.rippleText.textContent = "長休憩：水分補給。目を遠くに。";
    } else {
      ui.rippleText.textContent = "";
    }
  }

  // ---------------- Phase UI ----------------
  function updatePhaseUI(){
    const breakMode = isBreakPhase();
    ui.phaseDot.classList.toggle("break", breakMode);
    ui.bar.classList.toggle("break", breakMode);

    ui.phaseText.textContent =
      timer.phase === Phase.WORK ? "作業" :
      timer.phase === Phase.BREAK ? "休憩" : "長休憩";

    ui.setCount.textContent = String(timer.setIndex);
    ui.timeText.textContent = fmtMMSS(timer.remainingSec);

    const pct = timer.phaseTotalSec > 0
      ? ((timer.phaseTotalSec - timer.remainingSec) / timer.phaseTotalSec) * 100
      : 0;
    ui.bar.style.width = `${Math.min(100, Math.max(0, pct))}%`;

    document.title = `${ui.phaseText.textContent} ${fmtMMSS(timer.remainingSec)} - ポモドーロ`;

    updateRippleUI();
  }

  function setButtons(){
    ui.btnStart.disabled = timer.running;
    ui.btnPause.disabled = !timer.running;
  }

  function stopInterval(){
    if (timer.intervalId){
      clearInterval(timer.intervalId);
      timer.intervalId = null;
    }
    timer.running = false;
    setButtons();
  }

  function resetToPhase(phase){
    timer.phase = phase;
    if (phase === Phase.WORK){
      timer.phaseTotalSec = settings.workMin * 60;
      timer.remainingSec = settings.workMin * 60;
    } else if (phase === Phase.BREAK){
      timer.phaseTotalSec = settings.breakMin * 60;
      timer.remainingSec = settings.breakMin * 60;
    } else {
      timer.phaseTotalSec = settings.longMin * 60;
      timer.remainingSec = settings.longMin * 60;
    }
    updatePhaseUI();
  }

  function resetAll(){
    stopInterval();
    timer.setIndex = 1;
    resetToPhase(Phase.WORK);
  }

  // ---------------- WebAudio SE (system sound) ----------------
  const seSelect = $("seSelect");
  const btnSeTest = $("btnSeTest");
  let audioCtx = null;

  function ensureAudioCtx(){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!audioCtx) audioCtx = new Ctx();
    if (audioCtx.state !== "running") audioCtx.resume().catch(() => {});
  }

  function playTone({ freq=880, duration=0.12, type="sine", gain=0.08 } = {}){
    try{
      ensureAudioCtx();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();

      o.type = type;
      o.frequency.value = freq;

      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

      o.connect(g);
      g.connect(ctx.destination);

      o.start(now);
      o.stop(now + duration + 0.02);
    }catch(e){}
  }

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function playSwitchSE(){
    const mode = seSelect?.value || "";
    if (!mode) return;

    const goingToBreak = isBreakPhase(); // 既に次フェーズへ移ってから呼ばれる想定
    if (mode === "beep"){
      playTone({ freq: goingToBreak ? 660 : 880, duration: 0.10, type:"sine", gain:0.07 });
      return;
    }
    if (mode === "double"){
      playTone({ freq: goingToBreak ? 660 : 880, duration: 0.09, type:"sine", gain:0.07 });
      await sleep(120);
      playTone({ freq: goingToBreak ? 660 : 880, duration: 0.09, type:"sine", gain:0.07 });
      return;
    }
    if (mode === "ding"){
      playTone({ freq: goingToBreak ? 523 : 784, duration: 0.14, type:"triangle", gain:0.06 });
      await sleep(40);
      playTone({ freq: goingToBreak ? 659 : 988, duration: 0.08, type:"sine", gain:0.04 });
      return;
    }
    if (mode === "alarm"){
      for (let i=0;i<3;i++){
        playTone({ freq: 990, duration: 0.08, type:"square", gain:0.05 });
        await sleep(110);
      }
      return;
    }
  }

  if (btnSeTest){
    btnSeTest.addEventListener("click", async () => {
      ensureAudioCtx();
      // 「テスト」は“今のフェーズ”で鳴らす
      await playSwitchSE();
    });
  }

  // ---------------- BGM ----------------
  const bgm = $("bgm");
  const bgmSelect = $("bgmSelect");
  const btnBgmPlay = $("btnBgmPlay");
  const btnBgmStop = $("btnBgmStop");
  const bgmError = $("bgmError");
  const bgmWorkOn = $("bgmWorkOn");
  const bgmBreakOn = $("bgmBreakOn");

  function showBgmError(msg) {
    if (!bgmError) return;
    bgmError.textContent = msg;
    bgmError.classList.add("show");
  }
  function clearBgmError() {
    if (!bgmError) return;
    bgmError.textContent = "";
    bgmError.classList.remove("show");
  }

  function buildAudioUrl(fileName){
    return "audio/" + encodeURIComponent(fileName);
  }

  async function setBgmSrc(fileName) {
    bgm.pause();
    bgm.currentTime = 0;

    if (!fileName) {
      bgm.removeAttribute("src");
      bgm.load();
      clearBgmError();
      return;
    }

    const url = buildAudioUrl(fileName);

    try {
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) {
        showBgmError(`BGMファイルが見つかりません（${res.status}）。\n${url}\naudio/ に同名ファイルがあるか確認してください。`);
        return;
      }
      clearBgmError();
    } catch (e) {
      showBgmError(`BGMの確認中にエラー。\n${url}\nそのまま再生を試します。`);
    }

    bgm.src = url;
    bgm.load();
  }

  let audioUnlocked = false;
  async function unlockAudioOnce(){
    if (audioUnlocked) return;
    audioUnlocked = true;
    try{
      bgm.muted = true;
      await bgm.play();
      bgm.pause();
      bgm.currentTime = 0;
      bgm.muted = false;
    }catch(e){}
  }

  async function syncBgmForPhase(){
    const shouldPlay = isBreakPhase() ? !!bgmBreakOn?.checked : !!bgmWorkOn?.checked;

    if (!bgmSelect?.value) {
      bgm.pause();
      bgm.currentTime = 0;
      return;
    }

    if (shouldPlay){
      try{
        await setBgmSrc(bgmSelect.value);
        await bgm.play();
      }catch(e){}
    }else{
      bgm.pause();
      bgm.currentTime = 0;
    }
  }

  if (bgmSelect){
    bgmSelect.addEventListener("change", async () => {
      await setBgmSrc(bgmSelect.value);
    });
  }

  if (btnBgmPlay){
    btnBgmPlay.addEventListener("click", async () => {
      await unlockAudioOnce();
      if (bgmSelect?.value) await setBgmSrc(bgmSelect.value);
      try { await bgm.play(); } catch(e){
        showBgmError("BGMを再生できませんでした。最初の音出しはボタン操作が必要です。");
      }
    });
  }

  if (btnBgmStop){
    btnBgmStop.addEventListener("click", () => {
      bgm.pause();
      bgm.currentTime = 0;
      clearBgmError();
    });
  }

  // ---------------- Phase transition ----------------
  async function onPhaseComplete(){
    stopInterval();

    // メッセージ更新（切替時のみ）
    setRandomMessage();

    // 次フェーズへ
    if (timer.phase === Phase.WORK){
      resetToPhase(isLongBreakDue() ? Phase.LONG_BREAK : Phase.BREAK);
    } else {
      timer.setIndex = (timer.setIndex < settings.sets) ? (timer.setIndex + 1) : 1;
      resetToPhase(Phase.WORK);
    }

    // ここが「切替タイミング」：通知音（WebAudio）＋BGM自動制御
    await playSwitchSE();
    await syncBgmForPhase();

    if (settings.autoNext) startInterval();
  }

  function startInterval(){
    if (timer.running) return;
    timer.running = true;
    setButtons();

    timer.intervalId = setInterval(() => {
      timer.remainingSec -= 1;
      if (timer.remainingSec <= 0){
        timer.remainingSec = 0;
        updatePhaseUI();
        // ここからは async にしたいので setInterval 内では直接 await しない
        onPhaseComplete();
      } else {
        updatePhaseUI();
      }
    }, 1000);
  }

  function skipPhase(){
    timer.remainingSec = 0;
    updatePhaseUI();
    onPhaseComplete();
  }

  // ---------------- Apply button ----------------
  function applyRightPanelSettings(){
    settings.autoNext = !!ui.autoNext?.checked;
    ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
    ui.setTotal.textContent = String(settings.sets);

    // 停止中は「いまのフェーズ」に合わせてBGMを同期（チェックONなら鳴る）
    // ただしBGM再生は制限があるので、未解禁なら勝手には鳴らない（仕様）
    syncBgmForPhase();
  }

  if (ui.btnApply){
    ui.btnApply.addEventListener("click", () => {
      applyRightPanelSettings();
    });
  }

  // ---------------- Buttons ----------------
  ui.btnStart.addEventListener("click", async () => {
    // 音を確実に出すため、ユーザー操作時にWebAudio/BGMを起こす
    ensureAudioCtx();
    await unlockAudioOnce();

    applyRightPanelSettings();
    startInterval();
  });

  ui.btnPause.addEventListener("click", () => stopInterval());
  ui.btnReset.addEventListener("click", () => resetAll());
  ui.btnSkip.addEventListener("click", () => skipPhase());

  // ---------------- Init ----------------
  (function init(){
    // 左上表示
    ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
    ui.setTotal.textContent = String(settings.sets);

    // 初期メッセージ
    setRandomMessage();

    // 初期化
    resetAll();
    setButtons();

    // 初期BGMは選択だけ反映（再生はしない）
    if (bgmSelect?.value) setBgmSrc(bgmSelect.value);
  })();
})();
</script>
</body>
</html>
