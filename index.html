<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ポモドーロタイマー</title>
<style>
  :root{
    /* テーマ変数（JSから切替） */
    --bg1:#667eea;
    --bg2:#764ba2;
    --card: rgba(255,255,255,.15);
    --text:#ffffff;
    --muted: rgba(255,255,255,.88);

    --accent:#38bdf8;      /* 作業 */
    --break:#22c55e;       /* 休憩 */
    --start1:#22c55e;
    --start2:#16a34a;
    --stop1:#6b7280;
    --stop2:#4b5563;

    --shadow: rgba(0,0,0,.30);
    --radius: 18px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: var(--text);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 18px;
  }

  .wrap{
    width: min(980px, 100%);
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap: 16px;
  }
  @media (max-width: 860px){
    .wrap{ grid-template-columns: 1fr; }
  }

  .card{
    background: var(--card);
    border: 1px solid rgba(255,255,255,.18);
    border-radius: var(--radius);
    box-shadow: 0 14px 40px var(--shadow);
    padding: 18px;
    backdrop-filter: blur(8px);
  }

  .header{
    display:flex;
    justify-content:space-between;
    gap: 12px;
    align-items:flex-start;
    margin-bottom: 10px;
  }

  h1{ margin:0; font-size: 18px; letter-spacing:.02em; }
  .sub{ margin-top:6px; color: var(--muted); font-size: 13px; line-height: 1.5; }

  .pill{
    background: rgba(255,255,255,.16);
    border: 1px solid rgba(255,255,255,.18);
    padding: 8px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* タイマー表示 */
  .phaseRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top: 10px; }
  .phaseTag{
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 10px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: var(--muted);
    font-size: 12px;
  }
  .dot{ width:10px; height:10px; border-radius:999px; background: var(--accent); box-shadow: 0 0 12px rgba(56,189,248,.7); }
  .dot.break{ background: var(--break); box-shadow: 0 0 12px rgba(34,197,94,.65); }

  .bigTime{
    font-variant-numeric: tabular-nums;
    font-size: 64px;
    text-align:center;
    margin: 12px 0 10px;
    letter-spacing: .02em;
  }

  .progress{
    width:100%;
    height: 14px;
    background: rgba(255,255,255,.16);
    border-radius: 999px;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.18);
  }
  .bar{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(14,165,233,.85));
    border-radius: 999px;
    transition: width .25s linear;
  }
  .bar.break{
    background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(22,163,74,.85));
  }

  .controls{
    display:flex; flex-wrap:wrap; gap: 10px;
    justify-content:center; margin-top: 12px;
  }

  button{
    border:0;
    padding: 12px 14px;
    border-radius: 12px;
    cursor:pointer;
    color: var(--text);
    font-weight: 650;
    letter-spacing:.02em;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.18);
  }
  .primary{
    background: linear-gradient(135deg, var(--start1), var(--start2));
  }
  .secondary{
    background: linear-gradient(135deg, var(--stop1), var(--stop2));
  }
  .warn{
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  /* 右側設定 */
  label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  select, input[type="number"]{
    width:100%;
    padding: 12px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.18);
    color: var(--text);
    outline:none;
  }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

  .switch{
    display:flex; align-items:center; gap: 10px;
    padding: 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.16);
  }
  .switch input{ transform: scale(1.2); }

  .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }

  .hint{ color: var(--muted); font-size: 12px; line-height: 1.6; margin-top: 10px; }

  /* 左下メッセージ：大きめ */
  .message{
    font-size: 14px;
    line-height: 1.75;
  }
  @media (max-width: 860px){
    .message{ font-size: 13.5px; }
  }

  /* 休憩中だけ波紋アニメーション */
  .rippleWrap{
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-top: 6px;
    height: 140px;
  }

  .ripple{
    position:absolute;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    opacity: 0;
    border: 2px solid rgba(34,197,94,.65);
    box-shadow: 0 0 18px rgba(34,197,94,.25);
  }

  .rippleOn .ripple{
    opacity: 1;
    animation: ripple 2.6s ease-out infinite;
  }
  .rippleOn .ripple.r2{ animation-delay: .8s; }
  .rippleOn .ripple.r3{ animation-delay: 1.6s; }

  @keyframes ripple{
    0%   { transform: scale(1);   opacity: .0; }
    15%  { opacity: .65; }
    100% { transform: scale(14); opacity: 0; }
  }

  .rippleText{
    z-index: 2;
    color: rgba(255,255,255,.92);
    font-size: 13px;
    text-align:center;
    line-height: 1.5;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,.10);
    border: 1px solid rgba(255,255,255,.14);
  }

  /* エラー表示 */
  .error{
    margin-top: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.10);
    color: rgba(255,255,255,.92);
    font-size: 12px;
    line-height: 1.55;
    display:none;
  }
  .error.show{ display:block; }
</style>
</head>

<body>
  <div class="wrap">
    <!-- Left: Timer -->
    <section class="card">
      <div class="header">
        <div>
          <h1>ポモドーロタイマー</h1>
        </div>
        <div class="pill" id="presetLabel">Preset: 25/5</div>
      </div>

      <div class="phaseRow">
        <div class="phaseTag"><span class="dot" id="phaseDot"></span><span id="phaseText">作業</span></div>
        <div class="pill">セット: <span id="setCount">1</span> / <span id="setTotal">4</span></div>
      </div>

      <div class="bigTime" id="timeText">25:00</div>

      <div class="progress" aria-label="progress">
        <div class="bar" id="bar"></div>
      </div>

      <!-- 休憩中だけ波紋 -->
      <div class="rippleWrap" id="rippleWrap" aria-hidden="true">
        <div class="ripple r1"></div>
        <div class="ripple r2"></div>
        <div class="ripple r3"></div>
        <div class="rippleText" id="rippleText">休憩中：肩を落として、呼吸をひとつ。</div>
      </div>

      <div class="controls">
        <button class="primary" id="btnStart">開始</button>
        <button class="secondary" id="btnPause" disabled>一時停止</button>
        <button id="btnReset">リセット</button>
        <button class="warn" id="btnSkip">次へ</button>
      </div>

      <!-- 左下メッセージ（大きく＆ランダム） -->
      <div class="hint message" id="messageBox"></div>
    </section>

    <!-- Right: Settings + BGM -->
    <section class="card">
      <div class="header">
        <div>
          <h1>設定 / BGM</h1>
          <div class="sub">配色は3パターン。BGMはプルダウンで切替。休憩中に波紋が出ます。</div>
        </div>
      </div>

      <!-- 配色プルダウン（style内に入れない！） -->
      <div style="margin-bottom:12px;">
        <label for="themeSelect">配色</label>
        <select id="themeSelect">
          <option value="twilight">瞑想（Twilight）</option>
          <option value="sunrise">あたたかい（Sunrise）</option>
          <option value="mint">やさしい（Mint）</option>
        </select>
      </div>

      <div class="grid">
        <div>
          <label for="preset">プリセット</label>
          <select id="preset">
            <option value="25_5_4_15">標準 25/5（4セットごとに長休憩15）</option>
            <option value="50_10_2_20">深集中 50/10（2セットごとに長休憩20）</option>
            <option value="45_15_2_30">しっかり 45/15（2セットごとに長休憩30）</option>
            <option value="15_5_4_10">入門 15/5（4セットごとに長休憩10）</option>
            <option value="custom">カスタム</option>
          </select>
        </div>

        <div>
          <label for="sets">1サイクルのセット数</label>
          <input id="sets" type="number" min="1" max="12" value="4" />
        </div>

        <div>
          <label for="workMin">作業（分）</label>
          <input id="workMin" type="number" min="1" max="180" value="25" />
        </div>

        <div>
          <label for="breakMin">休憩（分）</label>
          <input id="breakMin" type="number" min="1" max="60" value="5" />
        </div>

        <div>
          <label for="longEvery">長休憩の頻度（何セットごと）</label>
          <input id="longEvery" type="number" min="0" max="12" value="4" />
        </div>

        <div>
          <label for="longMin">長休憩（分）</label>
          <input id="longMin" type="number" min="1" max="120" value="15" />
        </div>
      </div>

      <div style="margin-top:12px; display:grid; gap:10px;">
        <div class="switch">
          <input id="autoNext" type="checkbox" checked />
          <div>
            <div style="font-weight:650;">自動で次フェーズへ</div>
            <div class="hint" style="margin:6px 0 0;">ONだと、0秒で作業↔休憩を自動切替</div>
          </div>
        </div>

        <!-- BGM -->
        <div class="switch" style="display:block;">
          <label for="bgmSelect">BGM（プルダウン）</label>
          <select id="bgmSelect">
            <option value="">なし</option>
            <option value="10degrees_Celsius_2.mp3">10℃_2.mp3</option>
            <option value="2_23_AM_2.mp3">2_23_AM_2.mp3</option>
            <option value="Chill_Sunset.mp3">Chill_Sunset.mp3</option>
            <option value="You_and_Me_2.mp3">You_and_Me_2.mp3</option>
            <option value="優しい灯火(Tenderly_glow).mp3">優しい灯火(Tenderly_glow).mp3</option>
            <option value="神隠しの真相_2.mp3">神隠しの真相_2.mp3</option>
            <option value="野良猫は宇宙を目指した_2.mp3">野良猫は宇宙を目指した_2.mp3</option>
          </select>

          <div class="row" style="margin-top:10px;">
            <button id="btnBgmPlay">BGM 再生</button>
            <button id="btnBgmStop">BGM 停止</button>
          </div>

          <div class="hint" style="margin-top:10px;">
            注意：ブラウザ仕様で、最初の音出しは「ボタン押下」などユーザー操作が必要です。
          </div>

          <div class="error" id="bgmError"></div>

          <audio id="bgm" preload="none" loop></audio>
        </div>

        <div class="row">
          <button id="btnApply">設定を適用</button>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");
  const fmtMMSS = (sec) => {
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${pad2(m)}:${pad2(s)}`;
  };

  // ---------- Theme ----------
  const themeSelect = $("themeSelect");

  const THEMES = {
    twilight: {
      "--bg1": "#667eea",
      "--bg2": "#764ba2",
      "--card": "rgba(255,255,255,.15)",
      "--text": "#ffffff",
      "--muted": "rgba(255,255,255,.88)",
      "--accent": "#38bdf8",
      "--break": "#22c55e",
      "--start1": "#22c55e",
      "--start2": "#16a34a",
      "--stop1": "#6b7280",
      "--stop2": "#4b5563",
      "--shadow": "rgba(0,0,0,.30)",
    },
    sunrise: {
      "--bg1": "#fb7185",
      "--bg2": "#f59e0b",
      "--card": "rgba(255,255,255,.16)",
      "--text": "#ffffff",
      "--muted": "rgba(255,255,255,.90)",
      "--accent": "#60a5fa",
      "--break": "#34d399",
      "--start1": "#34d399",
      "--start2": "#10b981",
      "--stop1": "#6b7280",
      "--stop2": "#4b5563",
      "--shadow": "rgba(0,0,0,.28)",
    },
    mint: {
      "--bg1": "#34d399",
      "--bg2": "#06b6d4",
      "--card": "rgba(255,255,255,.14)",
      "--text": "#ffffff",
      "--muted": "rgba(255,255,255,.88)",
      "--accent": "#a78bfa",
      "--break": "#22c55e",
      "--start1": "#22c55e",
      "--start2": "#16a34a",
      "--stop1": "#6b7280",
      "--stop2": "#4b5563",
      "--shadow": "rgba(0,0,0,.28)",
    },
  };

  function applyTheme(key) {
    const t = THEMES[key] || THEMES.twilight;
    const root = document.documentElement;
    for (const [k, v] of Object.entries(t)) root.style.setProperty(k, v);
    try { localStorage.setItem("pomo_theme", key); } catch(e) {}
  }

  function loadTheme() {
    let saved = "twilight";
    try { saved = localStorage.getItem("pomo_theme") || "twilight"; } catch(e) {}
    if (themeSelect) themeSelect.value = saved;
    applyTheme(saved);
  }

  if (themeSelect) {
    themeSelect.addEventListener("change", () => applyTheme(themeSelect.value));
  }

  // ---------- Messages ----------
  const messageBox = $("messageBox");
  const MESSAGES = [
    "休憩は「回復」なので、サボりではありません。むしろ性能チューニングです。",
    "うまく回らない日でも、開始ボタンを押せた時点でちゃんと前に進んでます。",
    "集中は気合ではなく設計です。次の25分は“実験”にしましょう。",
    "完璧じゃなくていい。25分だけ前へ。小さく積むほど強い。",
    "止まっても戻れたらOK。中断は失敗じゃなく、調整です。",
    "休憩で回復したぶん、次の作業は軽くなります。脳は単純で可愛い。",
    "今日はスピードより継続。静かに積み上げる日でいきましょう。",
  ];
  function setRandomMessage() {
    if (!messageBox) return;
    const i = Math.floor(Math.random() * MESSAGES.length);
    messageBox.textContent = MESSAGES[i];
  }

  // ---------- BGM ----------
  const bgm = $("bgm");
  const bgmSelect = $("bgmSelect");
  const btnBgmPlay = $("btnBgmPlay");
  const btnBgmStop = $("btnBgmStop");
  const bgmError = $("bgmError");

  function showBgmError(msg) {
    if (!bgmError) return;
    bgmError.textContent = msg;
    bgmError.classList.add("show");
  }
  function clearBgmError() {
    if (!bgmError) return;
    bgmError.textContent = "";
    bgmError.classList.remove("show");
  }

  // fileName -> URL 生成（日本語/記号/空白対策）
  function buildAudioUrl(fileName) {
    // encodeURIComponent はパス区切り以外を全部安全にする
    return "audio/" + encodeURIComponent(fileName);
  }

  async function setBgmSrc(fileName) {
    bgm.pause();
    bgm.currentTime = 0;

    if (!fileName) {
      bgm.removeAttribute("src");
      bgm.load();
      clearBgmError();
      return;
    }

    const url = buildAudioUrl(fileName);

    // ここで存在確認。404なら「再生できない」ではなく「見つからない」を出す。
    try {
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) {
        showBgmError(`BGMファイルが見つかりません（${res.status}）。\n${url}\nGitHubの audio/ に同名ファイルがあるか確認してください。`);
        return;
      }
      clearBgmError();
    } catch (e) {
      // fetch が失敗しても src セットは試す
      showBgmError(`BGMの確認中にエラーが出ました。\n${url}\nそのまま再生を試します。`);
    }

    bgm.src = url;
    bgm.load();
  }

  bgmSelect.addEventListener("change", async () => {
    await setBgmSrc(bgmSelect.value);
  });

  btnBgmPlay.addEventListener("click", async () => {
    // 毎回選択値でsrcを作り直す（bgm.src が古いまま問題を潰す）
    if (bgmSelect.value) await setBgmSrc(bgmSelect.value);
    try {
      await bgm.play();
    } catch (e) {
      showBgmError(
        "BGMを再生できませんでした。\n" +
        "・ブラウザの自動再生制限（必ずボタン押下が必要）\n" +
        "・ファイルが404\n" +
        "・対応コーデックでない（mp3は通常OK）\n" +
        "の可能性があります。"
      );
    }
  });

  btnBgmStop.addEventListener("click", () => {
    bgm.pause();
    bgm.currentTime = 0;
    clearBgmError();
  });

  // ---------- Timer state ----------
  const Phase = { WORK:"work", BREAK:"break", LONG_BREAK:"long_break" };

  let settings = {
    workMin: 25,
    breakMin: 5,
    sets: 4,
    longEvery: 4,   // 0=なし
    longMin: 15,
    autoNext: true,
    presetLabel: "25/5",
  };

  let timer = {
    running: false,
    phase: Phase.WORK,
    setIndex: 1,
    remainingSec: 25*60,
    phaseTotalSec: 25*60,
    intervalId: null,
  };

  // ---------- UI ----------
  const ui = {
    preset: $("preset"),
    sets: $("sets"),
    workMin: $("workMin"),
    breakMin: $("breakMin"),
    longEvery: $("longEvery"),
    longMin: $("longMin"),
    autoNext: $("autoNext"),
    btnApply: $("btnApply"),

    btnStart: $("btnStart"),
    btnPause: $("btnPause"),
    btnReset: $("btnReset"),
    btnSkip: $("btnSkip"),

    presetLabel: $("presetLabel"),
    phaseDot: $("phaseDot"),
    phaseText: $("phaseText"),
    timeText: $("timeText"),
    bar: $("bar"),
    setCount: $("setCount"),
    setTotal: $("setTotal"),

    rippleWrap: $("rippleWrap"),
    rippleText: $("rippleText"),
  };

  function applySettingsToInputs(){
    ui.sets.value = settings.sets;
    ui.workMin.value = settings.workMin;
    ui.breakMin.value = settings.breakMin;
    ui.longEvery.value = settings.longEvery;
    ui.longMin.value = settings.longMin;
    ui.autoNext.checked = settings.autoNext;

    ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
    ui.setTotal.textContent = String(settings.sets);
  }

  function isBreakPhase() {
    return timer.phase === Phase.BREAK || timer.phase === Phase.LONG_BREAK;
  }

  function updateRippleUI(){
    ui.rippleWrap.classList.toggle("rippleOn", isBreakPhase());
    ui.rippleWrap.setAttribute("aria-hidden", isBreakPhase() ? "false" : "true");

    if (timer.phase === Phase.BREAK) {
      ui.rippleText.textContent = "休憩中：肩を落として、呼吸をひとつ。";
    } else if (timer.phase === Phase.LONG_BREAK) {
      ui.rippleText.textContent = "長休憩：水分補給。目を遠くに。";
    } else {
      ui.rippleText.textContent = "";
    }
  }

  function updatePhaseUI(){
    const breakMode = isBreakPhase();
    ui.phaseDot.classList.toggle("break", breakMode);
    ui.bar.classList.toggle("break", breakMode);

    ui.phaseText.textContent =
      timer.phase === Phase.WORK ? "作業" :
      timer.phase === Phase.BREAK ? "休憩" : "長休憩";

    ui.setCount.textContent = String(timer.setIndex);
    ui.timeText.textContent = fmtMMSS(timer.remainingSec);

    const pct = timer.phaseTotalSec > 0
      ? ((timer.phaseTotalSec - timer.remainingSec) / timer.phaseTotalSec) * 100
      : 0;
    ui.bar.style.width = `${Math.min(100, Math.max(0, pct))}%`;

    document.title = `${ui.phaseText.textContent} ${fmtMMSS(timer.remainingSec)} - ポモドーロ`;

    updateRippleUI();
  }

  function setButtons(){
    ui.btnStart.disabled = timer.running;
    ui.btnPause.disabled = !timer.running;
  }

  function stopInterval(){
    if (timer.intervalId){
      clearInterval(timer.intervalId);
      timer.intervalId = null;
    }
    timer.running = false;
    setButtons();
  }

  function startInterval(){
    if (timer.running) return;
    timer.running = true;
    setButtons();
    timer.intervalId = setInterval(() => {
      timer.remainingSec -= 1;
      if (timer.remainingSec <= 0){
        timer.remainingSec = 0;
        updatePhaseUI();
        onPhaseComplete();
      } else {
        updatePhaseUI();
      }
    }, 1000);
  }

  function resetToPhase(phase){
    timer.phase = phase;
    if (phase === Phase.WORK){
      timer.phaseTotalSec = settings.workMin * 60;
      timer.remainingSec = settings.workMin * 60;
    } else if (phase === Phase.BREAK){
      timer.phaseTotalSec = settings.breakMin * 60;
      timer.remainingSec = settings.breakMin * 60;
    } else {
      timer.phaseTotalSec = settings.longMin * 60;
      timer.remainingSec = settings.longMin * 60;
    }
    updatePhaseUI();
  }

  function resetAll(){
    stopInterval();
    timer.setIndex = 1;
    resetToPhase(Phase.WORK);
  }

  function isLongBreakDue(){
    if (settings.longEvery <= 0) return false;
    return (timer.setIndex % settings.longEvery) === 0;
  }

  function onPhaseComplete(){
    stopInterval();

    // フェーズ切替のタイミングでメッセージ更新（毎秒変わらない）
    setRandomMessage();

    if (timer.phase === Phase.WORK){
      resetToPhase(isLongBreakDue() ? Phase.LONG_BREAK : Phase.BREAK);
    } else {
      timer.setIndex = (timer.setIndex < settings.sets) ? (timer.setIndex + 1) : 1;
      resetToPhase(Phase.WORK);
    }

    if (settings.autoNext) startInterval();
  }

  function skipPhase(){
    timer.remainingSec = 0;
    updatePhaseUI();
    onPhaseComplete();
  }

  // ---------- Presets ----------
  function parsePresetValue(v){
    const [w,b,s,l] = v.split("_").map(x => parseInt(x, 10));
    return { workMin:w, breakMin:b, sets:s, longEvery:s, longMin:l };
  }

  function applyPreset(value){
    if (value === "custom"){
      settings.presetLabel = "Custom";
      ui.presetLabel.textContent = `Preset: ${settings.presetLabel}`;
      return;
    }
    const p = parsePresetValue(value);
    settings.workMin = p.workMin;
    settings.breakMin = p.breakMin;
    settings.sets = p.sets;
    settings.longEvery = p.longEvery;
    settings.longMin = p.longMin;
    settings.presetLabel = `${p.workMin}/${p.breakMin}`;
    applySettingsToInputs();
  }

  function readSettingsFromInputs(){
    const workMin = Math.max(1, Math.min(180, parseInt(ui.workMin.value,10) || 25));
    const breakMin = Math.max(1, Math.min(60, parseInt(ui.breakMin.value,10) || 5));
    const sets = Math.max(1, Math.min(12, parseInt(ui.sets.value,10) || 4));
    const longEvery = Math.max(0, Math.min(12, parseInt(ui.longEvery.value,10) || 0));
    const longMin = Math.max(1, Math.min(120, parseInt(ui.longMin.value,10) || 15));

    settings.workMin = workMin;
    settings.breakMin = breakMin;
    settings.sets = sets;
    settings.longEvery = longEvery;
    settings.longMin = longMin;
    settings.autoNext = ui.autoNext.checked;

    settings.presetLabel = `${settings.workMin}/${settings.breakMin}`;
  }

  // ---------- Events ----------
  ui.preset.addEventListener("change", () => applyPreset(ui.preset.value));

  ui.btnApply.addEventListener("click", () => {
    readSettingsFromInputs();
    applySettingsToInputs();
    if (!timer.running) resetAll();
  });

  ui.btnStart.addEventListener("click", () => startInterval());
  ui.btnPause.addEventListener("click", () => stopInterval());
  ui.btnReset.addEventListener("click", () => resetAll());
  ui.btnSkip.addEventListener("click", () => skipPhase());

  // ---------- Init ----------
  (function init(){
    loadTheme();
    applySettingsToInputs();
    resetAll();
    setButtons();

    // 初回メッセージ
    setRandomMessage();

    // 初期BGM選択の反映（任意）
    // bgmSelect.value が「なし」以外なら、選択中の曲の存在だけ確認しておく
    if (bgmSelect.value) setBgmSrc(bgmSelect.value);
  })();

})();
</script>
</body>
</html>
